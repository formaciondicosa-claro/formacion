<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Formación DICO – Asistencia (Admin + Formador)</title>

<!-- Supabase JS v2 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<!-- XLSX -->
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --violeta:#a78bfa; --violeta-osc:#7c3aed;
  --bg:#050617; --bg2:#111827; --card:#17182b;
  --text:#e8e6ff; --muted:#bfbde6; --border-soft:rgba(167,139,250,.25);
  --danger:#f97373; --success:#34d399; --warn:#facc15;
}
*{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,sans-serif;}
body{
  margin:0;min-height:100vh;
  background:radial-gradient(circle at top,var(--bg2),var(--bg));
  color:var(--text);
  display:flex;align-items:center;justify-content:center;
  padding:16px;
}
.hidden{display:none!important;}
.card{
  width:100%;max-width:480px;
  background:rgba(23,24,43,.85);
  border:1px solid var(--border-soft);
  border-radius:16px;
  padding:22px;
  box-shadow:0 20px 45px rgba(0,0,0,.55);
}
h1{margin:0 0 6px 0;color:var(--violeta);text-align:center;}
p{margin:0 0 14px 0;color:var(--muted);text-align:center;font-size:14px;}
label{display:block;margin-top:10px;color:var(--muted);font-size:12px;}
input, select, textarea{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  border:1px solid var(--border-soft);
  background:#0b0c1a;
  color:var(--text);
  font-size:14px;
}
input:focus, select:focus, textarea:focus{outline:none;border-color:var(--violeta);}
button{
  border:0;border-radius:10px;
  padding:12px 14px;
  background:var(--violeta);
  color:#050617;font-weight:900;
  cursor:pointer;
}
button:hover{background:var(--violeta-osc);}
button:disabled{opacity:.55;cursor:not-allowed;}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--border-soft);
  color:var(--muted);
  font-size:12px;
}
.small{font-size:12px;color:var(--muted);}
.ok{color:var(--success);font-weight:800;}
.err{color:var(--danger);font-weight:800;}
.warn{color:var(--warn);font-weight:800;}

.app{width:100%;max-width:1200px;}
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;margin-bottom:14px;flex-wrap:wrap;
}
.titleblock h2{margin:0;font-size:20px;}
.titleblock .small{margin-top:2px;}
.pillrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.grid{
  display:grid;
  grid-template-columns: 430px 1fr;
  gap:14px;
}
.grid.onecol{
  grid-template-columns: 1fr;
}
@media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

.panel{
  background:rgba(23,24,43,.75);
  border:1px solid var(--border-soft);
  border-radius:16px;
  padding:14px;
  box-shadow:0 18px 40px rgba(0,0,0,.4);
}
.panel h3{margin:0 0 10px 0;color:var(--violeta);}
hr{border:0;border-top:1px solid var(--border-soft);margin:12px 0;}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.col{flex:1;min-width:160px;}
.list{display:flex;flex-direction:column;gap:10px;}
.item{
  background:rgba(5,6,23,.35);
  border:1px solid var(--border-soft);
  border-radius:14px;
  padding:12px;
}
.item b{color:var(--text);}
.kv{display:grid;grid-template-columns: 140px 1fr;gap:6px;margin-top:6px;}
.kv div{font-size:12px;color:var(--muted);}
.kv div:nth-child(odd){color:rgba(191,189,230,.9);}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
pre{
  white-space:pre-wrap;
  background:#0b0c1a;
  border:1px solid var(--border-soft);
  border-radius:12px;
  padding:12px;
  margin:10px 0 0 0;
  color:var(--text);
  font-size:12px;
  overflow:auto;
  max-height:260px;
}
.chip{
  border:1px solid var(--border-soft);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  color:var(--muted);
  background:rgba(5,6,23,.25);
}
.tablelike{
  width:100%;
  border:1px solid var(--border-soft);
  border-radius:14px;
  overflow:hidden;
}
.tablelike .tr{
  display:grid;
  grid-template-columns: 1fr 120px 120px 120px; /* ✅ 4 columnas */
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid rgba(167,139,250,.18);
}
.tablelike .tr:last-child{border-bottom:0;}
.tablelike .th{
  background:rgba(5,6,23,.45);
  color:var(--muted);
  font-size:12px;
  font-weight:800;
}
.btnMini{padding:10px 12px;border-radius:10px;font-weight:900;}
.btnGhost{background:transparent;border:1px solid var(--border-soft);color:var(--text);}
.btnGhost:hover{background:rgba(167,139,250,.10);}
.btnDanger{background:transparent;border:1px solid rgba(248,113,113,.65);color:#ffd8d8;}
.btnDanger:hover{border-color:rgba(248,113,113,1);}
.btnOk{background:rgba(52,211,153,.95); color:#050617;}
.btnBad{background:rgba(248,113,113,.95); color:#050617;}
.btnOk:hover,.btnBad:hover{filter:brightness(1.05);}
code{color:#fff;}

/* ===== FORMADOR: ocultar panel izquierdo + 1 columna (SIN tocar JS) ===== */
body.formador .grid{
  grid-template-columns: 1fr !important;
}
body.formador #leftPanel{
  display:none !important;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="card">

  <h1>Formación DICO</h1>
  <p>Ingreso al sistema de asistencia</p>

  <label>Correo</label>
  <input id="email" type="email" placeholder="correo@dico.com.co" autocomplete="username" />

  <label>Contraseña</label>
  <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />

  <div class="row" style="margin-top:14px;">
    <button id="btnLogin" type="button" style="width:100%;">Ingresar</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="btnForgot" type="button" class="btnMini btnGhost" style="width:100%;">Recuperar contraseña (crear clave)</button>
  </div>

  <div id="loginMsg" class="small" style="margin-top:10px;text-align:center;"></div>
</div>

<!-- RESET PASSWORD -->
<div id="resetBox" class="card hidden">
  <h1>Restablecer contraseña</h1>
  <p>Ingresa tu nueva contraseña para finalizar la recuperación</p>

  <label>Nueva contraseña</label>
  <input id="newPassword" type="password" placeholder="Mínimo 6 caracteres" autocomplete="new-password" />

  <label>Confirmar contraseña</label>
  <input id="newPassword2" type="password" placeholder="Repite la contraseña" autocomplete="new-password" />

  <div class="row" style="margin-top:14px;">
    <button id="btnReset" type="button" style="width:100%;">Guardar contraseña</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="btnResetBack" type="button" class="btnMini btnGhost" style="width:100%;">Volver al login</button>
  </div>

  <div id="resetMsg" class="small" style="margin-top:10px;text-align:center;"></div>
</div>

<!-- APP -->
<div id="app" class="hidden app">
  <div class="topbar">
    <div class="titleblock">
      <h2 id="panelTitle">Panel</h2>
      <div class="small" id="whoami">—</div>
    </div>
    <div class="pillrow">
      <span class="badge" id="roleBadge">rol</span>

      <button id="btnRevokeOthers" class="btnMini btnDanger hidden" type="button" title="Cierra sesiones activas en otros dispositivos (no te saca a ti)">
        Cerrar otras sesiones
      </button>

      <button id="btnLogout" class="btnMini" type="button">Cerrar sesión</button>
    </div>
  </div>

  <div class="grid">
    <div class="panel" id="leftPanel"></div>
    <div class="panel" id="rightPanel"></div>
  </div>

  <div class="panel" style="margin-top:14px;">
    <h3>Estado</h3>
    <div id="status" class="small">Listo.</div>
    <pre id="log">(vacío)</pre>
  </div>
</div>

<script>
/* =========================================================
   CONFIGURA AQUÍ TUS DATOS DE SUPABASE
========================================================= */
const SUPABASE_URL = "https://bqlltjronzrlgbjjntes.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_j84bjNzsEw1O-zsvliQ4Wg_BhGkSqR_"; // debe estar COMPLETA

const EMP_HEADERS = ["documento","nombre","cargo","area","supervisor","email","estado"];
const CITE_HEADERS = ["session_id","documento"]; // para carga masiva

/* =========================================================
   HELPERS
========================================================= */
const $ = (id) => document.getElementById(id);
const $status = $("status");
const $log = $("log");

function setStatus(html){ $status.innerHTML = html; }
function setLog(obj){ $log.textContent = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2); }
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"quot;").replaceAll("'","&#039;");
}
function val(x){ return String(x ?? "").trim(); }

/* ========= NUEVO: helpers Tema visto ========= */
function normDateISO(d){
  const s = String(d || "").trim();
  if(!s) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  return s.slice(0,10);
}
async function getTemaVisto(sb, session_id, fechaISO){
  const { data, error } = await sb
    .from("session_dates")
    .select("tema_visto")
    .eq("session_id", session_id)
    .eq("fecha", fechaISO)
    .maybeSingle();

  if(error) throw error;
  return (data?.tema_visto ?? "").toString().trim();
}
/* =========================================== */

function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function addDaysISO(isoDate, days){
  const d = new Date(isoDate+"T00:00:00");
  d.setDate(d.getDate() + days);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function downloadTextFile(content, filename, mime){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 600);
}

/* =========================================================
   DETECCIÓN RESET (desde email)
========================================================= */
function isRecoveryFlow(){
  const h = (window.location.hash || "").toLowerCase();
  return h.includes("type=recovery") || h.includes("#reset") || h.includes("access_token=");
}
function showOnly(view){
  $("login").classList.toggle("hidden", view !== "login");
  $("resetBox").classList.toggle("hidden", view !== "reset");
  $("app").classList.toggle("hidden", view !== "app");
}
function goToLogin(){
  window.location.hash = "";
  showOnly("login");
  $("loginMsg").innerHTML = `<span class="small">Listo para iniciar sesión.</span>`;
}

/* =========================================================
   CSV / XLSX (robusto)
========================================================= */
function parseDelimited(text){
  text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
  const firstLine = (text.split("\n").find(l => l.trim().length) || "");
  const commas = (firstLine.match(/,/g)||[]).length;
  const semis  = (firstLine.match(/;/g)||[]).length;
  const delim = semis > commas ? ";" : ",";

  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0;i<text.length;i++){
    const c = text[i];
    const n = text[i+1];
    if(c === '"'){
      if(inQuotes && n === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if(c === delim && !inQuotes){ row.push(cur); cur=""; continue; }
    if(c === "\n" && !inQuotes){ row.push(cur); rows.push(row); row=[]; cur=""; continue; }
    cur += c;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }

  const cleaned = rows.map(r => r.map(c => (c ?? "").toString())).filter(r => r.some(c => c.trim() !== ""));
  return cleaned;
}
function parseXLSX(arrayBuffer){
  if(!window.XLSX) throw new Error("La librería XLSX no cargó (bloqueada). Usa CSV.");
  const wb = XLSX.read(arrayBuffer, { type: "array" });
  const sheet = wb.Sheets[wb.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });
  return json.map(r => r.map(c => (c ?? "").toString())).filter(r => r.some(c => String(c).trim() !== ""));
}

/* =========================================================
   SUPABASE
========================================================= */
function getSB(){
  if(!window.supabase || !window.supabase.createClient){
    throw new Error("No se cargó Supabase JS. Abre desde Live Server/GitHub Pages o revisa bloqueos.");
  }
  window.__sb = window.__sb || window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_PUBLISHABLE_KEY,
    {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    }
  );
  return window.__sb;
}

/* =========================================================
   AUTH
========================================================= */
async function doLogin(){
  const sb = getSB();
  const email = val($("email").value);
  const password = val($("password").value);
  const btn = $("btnLogin");
  const msg = $("loginMsg");

  msg.innerHTML = "";
  if(!email || !password){
    msg.innerHTML = `<span class="err">Debes ingresar correo y contraseña.</span>`;
    return;
  }

  btn.disabled = true;
  btn.textContent = "Ingresando...";
  msg.innerHTML = `<span class="small">Validando...</span>`;

  try{
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    setLog({ login_data: data, login_error: error });

    if(error){
      msg.innerHTML = `<span class="err">${esc(error.message)}</span>`;
      return;
    }
    if(!data?.session){
      msg.innerHTML = `<span class="err">No se obtuvo sesión. Revisa credenciales.</span>`;
      return;
    }

    await bootApp();
  }catch(e){
    msg.innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
  }finally{
    btn.disabled = false;
    btn.textContent = "Ingresar";
  }
}

async function doForgot(){
  const sb = getSB();
  const email = val($("email").value);
  const msg = $("loginMsg");
  msg.innerHTML = "";

  if(!email){
    msg.innerHTML = `<span class="err">Escribe el correo en el campo Correo.</span>`;
    return;
  }

  try{
    const redirectTo = `${window.location.origin}${window.location.pathname}#reset`;
    const { data, error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
    setLog({ reset_data: data, reset_error: error, redirectTo });

    if(error){
      msg.innerHTML = `<span class="err">${esc(error.message)}</span>`;
      return;
    }
    msg.innerHTML = `<span class="ok">Listo.</span> Revisa tu correo para crear la contraseña y luego intenta ingresar.`;
  }catch(e){
    msg.innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
  }
}

async function doLogout(){
  const sb = getSB();
  await sb.auth.signOut();
  location.reload();
}

async function doRevokeOtherSessions(){
  const sb = getSB();
  const ok = confirm("Esto cerrará sesiones activas en otros dispositivos para tu usuario.\n\n¿Continuar?");
  if(!ok) return;

  try{
    setStatus("Cerrando otras sesiones...");
    const { error } = await sb.auth.signOut({ scope: "others" });
    if(error) throw error;
    setStatus(`<span class="ok">Listo.</span> Otras sesiones cerradas.`);
    setLog({ revoke_other_sessions: "ok" });
  }catch(e){
    setStatus(`<span class="err">Error:</span> ${esc(e.message || e)}`);
    setLog(e);
  }
}

async function doResetPassword(){
  const sb = getSB();
  const msg = $("resetMsg");
  const btn = $("btnReset");

  const p1 = val($("newPassword").value);
  const p2 = val($("newPassword2").value);

  msg.innerHTML = "";

  if(!p1 || p1.length < 6){
    msg.innerHTML = `<span class="err">Mínimo 6 caracteres.</span>`;
    return;
  }
  if(p1 !== p2){
    msg.innerHTML = `<span class="err">Las contraseñas no coinciden.</span>`;
    return;
  }

  btn.disabled = true;
  btn.textContent = "Guardando...";

  try{
    const { data: sess } = await sb.auth.getSession();
    if(!sess?.session){
      msg.innerHTML = `<span class="err">El enlace expiró o es inválido.</span><br/><span class="small">Vuelve a pulsar "Recuperar contraseña" y usa el correo más reciente.</span>`;
      return;
    }

    const { data, error } = await sb.auth.updateUser({ password: p1 });
    setLog({ updateUser_data: data, updateUser_error: error });

    if(error){
      msg.innerHTML = `<span class="err">${esc(error.message)}</span>`;
      return;
    }

    msg.innerHTML = `<span class="ok">Contraseña actualizada.</span> Ya puedes iniciar sesión.`;
    setTimeout(() => { goToLogin(); }, 1200);

  }catch(e){
    msg.innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
    setLog(e);
  }finally{
    btn.disabled = false;
    btn.textContent = "Guardar contraseña";
  }
}

/* =========================================================
   PROFILE
========================================================= */
async function getProfile(user){
  const sb = getSB();
  const { data, error } = await sb
    .from("profiles")
    .select("user_id,nombre,rol,activo")
    .eq("user_id", user.id)
    .maybeSingle();

  if(error) throw error;

  if(!data){
    return { user_id: user.id, nombre: (user.email||"usuario").split("@")[0], rol: "formador", activo: true, __missing:true };
  }
  return data;
}

/* =========================================================
   UI
========================================================= */
function setPanels(role){
  if(role === "super_admin"){
    $("leftPanel").innerHTML = renderAdminLeft();
    $("rightPanel").innerHTML = renderAdminRight();
    wireAdminHandlers();
  }else{
    $("leftPanel").innerHTML = renderTrainerLeft();
    $("rightPanel").innerHTML = renderTrainerRight();
    wireTrainerHandlers();
  }
}

function renderAdminLeft(){
  return `
    <h3>Asignación de entrenamientos</h3>
    <div class="small">Crea entrenamientos, sesiones, carga personal y cita empleados.</div>
    <hr/>

    <div class="item">
      <b>1) Cargar personal (employees)</b>
      <div class="small">Sube CSV o XLSX. Encabezados requeridos: <code>${EMP_HEADERS.join(", ")}</code></div>
      <div class="actions" style="margin-top:8px;">
        <button id="btnEmpTemplateCSV" class="btnMini btnGhost" type="button">Descargar plantilla CSV</button>
        <button id="btnEmpTemplateXLSX" class="btnMini btnGhost" type="button">Plantilla XLSX</button>
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="empFile" type="file" accept=".csv,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv" />
        <button id="btnEmpUpload" class="btnMini" type="button">Subir e insertar</button>
      </div>
      <div id="empMsg" class="small" style="margin-top:8px;"></div>
    </div>

    <hr/>

    <div class="item">
      <b>2) Crear entrenamiento</b>
      <div class="small">Solo crea el tipo de capacitación y su duración.</div>

      <label>Nombre del entrenamiento</label>
      <input id="trNombre" placeholder="Ej: Trabajo en alturas" />

      <div class="row">
        <div class="col">
          <label>Duración (días)</label>
          <input id="trDuracion" type="number" min="1" max="3650" value="1" />
        </div>
        <div class="col">
          <label>¿Certifica?</label>
          <select id="trCertifica">
            <option value="true">Sí</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>

      <button id="btnCreateTraining" style="margin-top:12px;width:100%;" type="button">Guardar entrenamiento</button>
      <div id="trMsg" class="small" style="margin-top:8px;"></div>
    </div>

    <hr/>

    <div class="item">
      <b>3) Crear sesión</b>
      <div class="small">
        Pegas el <code>training_id</code>. Luego el sistema genera <b>fechas reales</b> según duración.
      </div>

      <label>training_id (uuid)</label>
      <input id="sessionTrainingId" placeholder="Pega aquí el training_id" />

      <div class="row">
        <div class="col">
          <label>Fecha inicio</label>
          <input id="sessionFecha" type="date" />
        </div>
        <div class="col">
          <label>Ciudad</label>
          <input id="sessionCiudad" placeholder="Ej: Bogotá" />
        </div>
      </div>

      <label>Formador</label>
      <select id="sessionFormador"></select>

      <label>Estado (opcional)</label>
      <input id="sessionEstado" placeholder="programada" value="programada" />

      <button id="btnCreateSession" style="margin-top:12px;width:100%;" type="button">Crear sesión</button>
      <div id="sessionMsg" class="small" style="margin-top:8px;"></div>

      <div id="datesBox" class="hidden" style="margin-top:12px;">
        <b style="display:block;margin-bottom:6px;">Fechas del entrenamiento</b>
        <div class="small">
          Se crean según <code>trainings.vigencia_dias</code>. Puedes editar fechas y guardar.
        </div>
        <div id="datesList" class="list" style="margin-top:10px;"></div>
        <button id="btnSaveDates" class="btnMini btnGhost" style="margin-top:10px;width:100%;" type="button">Guardar fechas</button>
        <div id="datesMsg" class="small" style="margin-top:8px;"></div>
      </div>
    </div>

    <hr/>

    <div class="item">
      <b>4) Citar empleados a una sesión</b>
      <div class="small">Selecciona sesión, busca empleado y cita.</div>

      <label>Sesión</label>
      <select id="citeSession"></select>

      <div class="row">
        <div class="col">
          <label>Buscar empleado (documento o nombre)</label>
          <input id="empSearch" placeholder="Ej: 123456 o Juan" />
        </div>
        <div class="col" style="min-width:180px;">
          <label>&nbsp;</label>
          <button id="btnSearchEmp" class="btnMini btnGhost" type="button">Buscar</button>
        </div>
      </div>

      <div id="empResults" class="list" style="margin-top:10px;"></div>
      <div id="citeMsg" class="small" style="margin-top:8px;"></div>

      <hr/>

      <b>4B) Carga masiva de citaciones (Excel/CSV)</b>
      <div class="small">Archivo con columnas: <code>${CITE_HEADERS.join(", ")}</code></div>
      <div class="actions" style="margin-top:8px;">
        <button id="btnCiteTemplateCSV" class="btnMini btnGhost" type="button">Plantilla CSV</button>
        <button id="btnCiteTemplateXLSX" class="btnMini btnGhost" type="button">Plantilla XLSX</button>
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="citeFile" type="file" accept=".csv,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv" />
        <button id="btnCiteUpload" class="btnMini" type="button">Cargar citaciones</button>
      </div>
      <div id="citeUploadMsg" class="small" style="margin-top:8px;"></div>
    </div>
  `;
}

function renderAdminRight(){
  return `
    <h3>Sesiones</h3>
    <div class="small">Lista de sesiones creadas (últimas 50).</div>
    <hr/>
   <div class="row">
  <button id="btnRefreshAdmin" class="btnMini btnGhost" type="button">Actualizar</button>
  <a class="btnMini btnGhost"
   href="./dashboard_super_admin.html"
   target="_blank"
   rel="noopener"
   style="display:inline-block;text-decoration:none;text-align:center;">
  Ver Dashboard
</a>
</div>
    <div id="adminSessions" class="list" style="margin-top:12px;"></div>
  `;
}

function renderTrainerLeft(){
  return `
    <h3>Formador</h3>
    <div class="small">Verás tus sesiones y marcarás asistencia por fecha real.</div>
    <hr/>
    <div class="item">
      <b>Acciones</b>
      <div class="actions">
        <button id="btnRefreshTrainer" class="btnMini btnGhost" type="button">Actualizar</button>
      </div>
    </div>
  `;
}

function renderTrainerRight(){
  return `
    <h3>Mis sesiones</h3>
    <div class="small">Sesiones donde tú eres el formador. Selecciona la fecha y marca asistencia.</div>
    <hr/>
    <div id="trainerSessions" class="list"></div>
  `;
}

/* =========================================================
   BOOT
========================================================= */
let STATE = { user:null, profile:null };

async function bootApp(){
  const sb = getSB();
  const { data: { session } } = await sb.auth.getSession();

  if(!session){
    showOnly("login");
    $("loginMsg").innerHTML = `<span class="small">Listo para iniciar sesión.</span>`;
    return;
  }

  const user = session.user;
  const profile = await getProfile(user);

  STATE.user = user;
  STATE.profile = profile;

  showOnly("app");

  $("whoami").textContent = `${user.email}  ·  ${profile.nombre || ""}  ·  uid: ${user.id}`;
  $("roleBadge").textContent = profile.rol || "formador";
  $("panelTitle").textContent = (profile.rol === "super_admin") ? "Módulo: Asignación de entrenamientos" : "Panel Formador";
  document.body.classList.toggle("formador", profile.rol !== "super_admin");
  $("btnLogout").onclick = doLogout;

  if(profile.rol === "super_admin"){
    $("btnRevokeOthers").classList.remove("hidden");
    $("btnRevokeOthers").onclick = doRevokeOtherSessions;
  }else{
    $("btnRevokeOthers").classList.add("hidden");
  }

  setPanels(profile.rol);

  if(profile.__missing){
    setStatus(`<span class="warn">Aviso:</span> No existe tu fila en <code>profiles</code>.`);
  }else{
    setStatus(`<span class="ok">Sesión activa.</span>`);
  }

  setLog({ session_user: user, profile });

  if(profile.rol === "super_admin"){
    await adminInit();
  }else{
    await trainerInit();
  }
}

/* =========================================================
   ADMIN
========================================================= */
function wireAdminHandlers(){
  $("btnEmpTemplateCSV").onclick = () => {
    const csv = EMP_HEADERS.join(",") + "\n";
    downloadTextFile(csv, "plantilla_empleados.csv", "text/csv;charset=utf-8");
    setStatus(`<span class="ok">Plantilla CSV descargada.</span>`);
    setLog(csv);
  };

  $("btnEmpTemplateXLSX").onclick = () => {
    try{
      if(!window.XLSX) throw new Error("XLSX bloqueado. Usa la plantilla CSV.");
      const ws = XLSX.utils.aoa_to_sheet([EMP_HEADERS]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "plantilla");
      const out = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const blob = new Blob([out], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "plantilla_empleados.xlsx";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 600);
      setStatus(`<span class="ok">Plantilla XLSX descargada.</span>`);
      setLog({ headers: EMP_HEADERS });
    }catch(e){
      setStatus(`<span class="err">Error:</span> ${esc(e.message || e)}`);
      setLog(e);
    }
  };

  $("btnCiteTemplateCSV").onclick = () => {
    const csv = CITE_HEADERS.join(",") + "\n";
    downloadTextFile(csv, "plantilla_citaciones.csv", "text/csv;charset=utf-8");
    setStatus(`<span class="ok">Plantilla citaciones CSV descargada.</span>`);
    setLog(csv);
  };

  $("btnCiteTemplateXLSX").onclick = () => {
    try{
      if(!window.XLSX) throw new Error("XLSX bloqueado. Usa CSV.");
      const ws = XLSX.utils.aoa_to_sheet([CITE_HEADERS]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "citaciones");
      const out = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const blob = new Blob([out], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "plantilla_citaciones.xlsx";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 600);
      setStatus(`<span class="ok">Plantilla citaciones XLSX descargada.</span>`);
      setLog({ headers: CITE_HEADERS });
    }catch(e){
      setStatus(`<span class="err">Error:</span> ${esc(e.message || e)}`);
      setLog(e);
    }
  };

  $("btnEmpUpload").onclick = adminUploadEmployees;
  $("btnCreateTraining").onclick = adminCreateTraining;
  $("btnCreateSession").onclick = adminCreateSession;
  $("btnSaveDates").onclick = adminSaveSessionDates;
  $("btnRefreshAdmin").onclick = adminRefreshAll;
  $("btnSearchEmp").onclick = adminSearchEmployees;
  $("btnCiteUpload").onclick = adminUploadCitations;
}

async function adminInit(){
  $("sessionFecha").value = todayISO();
  await adminRefreshAll();
}

async function adminRefreshAll(){
  await Promise.all([
    adminLoadFormadores(),
    adminLoadSessions(),
    adminLoadSessionSelects()
  ]);
}

async function adminLoadFormadores(){
  const sb = getSB();
  const sel = $("sessionFormador");
  sel.innerHTML = `<option value="">Cargando formadores...</option>`;

  const { data, error } = await sb
    .from("profiles")
    .select("user_id,nombre,rol,activo")
    .eq("activo", true)
    .order("nombre", { ascending:true });

  if(error){
    sel.innerHTML = `<option value="">(error)</option>`;
    setStatus(`<span class="err">Error profiles:</span> ${esc(error.message)}`);
    setLog(error);
    return;
  }

  const formadores = (data || []).filter(p => (p.rol || "") === "formador");
  if(!formadores.length){
    sel.innerHTML = `<option value="">(No hay formadores en profiles)</option>`;
    return;
  }

  sel.innerHTML = `<option value="">Selecciona formador...</option>` + formadores
    .map(p => `<option value="${p.user_id}">${esc(p.nombre)} · ${p.user_id}</option>`)
    .join("");
}

async function adminLoadSessions(){
  const sb = getSB();
  const cont = $("adminSessions");
  cont.innerHTML = `<div class="small">Cargando...</div>`;

  const { data, error } = await sb
    .from("sessions")
    .select(`id, training_id, fecha, ciudad, formador_user_id, estado, created_at, trainings ( nombre )`)
    .order("fecha", { ascending:false })
    .limit(50);

  if(error){
    cont.innerHTML = `<div class="small"><span class="err">Error:</span> ${esc(error.message)}</div>`;
    setStatus(`<span class="err">Error sessions:</span> ${esc(error.message)}`);
    setLog(error);
    return;
  }

  if(!data?.length){
    cont.innerHTML = `<div class="item"><div class="small">No hay sesiones registradas.</div></div>`;
    return;
  }

  cont.innerHTML = data.map(s => {
    const trName = s.trainings?.nombre || "Entrenamiento";
    return `
      <div class="item">
        <div class="row" style="justify-content:space-between;">
          <div><b>${esc(trName)}</b></div>
          <span class="chip">${esc(s.estado || "—")}</span>
        </div>
        <div class="small" style="margin-top:6px;">Sesión · ${esc(s.fecha)} · ${esc(s.ciudad || "")}</div>
        <div class="kv">
          <div>session_id</div><div><code>${esc(s.id)}</code></div>
          <div>training_id</div><div><code>${esc(s.training_id || "")}</code></div>
          <div>formador_user_id</div><div><code>${esc(s.formador_user_id || "")}</code></div>
        </div>
        <div class="actions">
          <button class="btnMini btnDanger" type="button" onclick="adminDeleteSession('${s.id}')">Eliminar sesión</button>
        </div>
      </div>
    `;
  }).join("");
}

async function adminLoadSessionSelects(){
  const sb = getSB();
  const sel = $("citeSession");
  sel.innerHTML = `<option value="">Cargando sesiones...</option>`;

  const { data, error } = await sb
    .from("sessions")
    .select(`id,fecha,ciudad,estado, trainings ( nombre )`)
    .order("fecha", { ascending:false })
    .limit(150);

  if(error){
    sel.innerHTML = `<option value="">(error)</option>`;
    setStatus(`<span class="err">Error selector sesiones:</span> ${esc(error.message)}`);
    setLog(error);
    return;
  }

  if(!data?.length){
    sel.innerHTML = `<option value="">(No hay sesiones)</option>`;
    return;
  }

  sel.innerHTML = `<option value="">Selecciona sesión...</option>` + data.map(s => {
    const trName = s.trainings?.nombre || "Entrenamiento";
    const tag = `${trName} · ${s.fecha} · ${s.ciudad || ""} · ${s.id}`;
    return `<option value="${s.id}">${esc(tag)}</option>`;
  }).join("");
}

/* ===========================
   ADMIN placeholders (igual)
=========================== */
async function adminCreateTraining(){ /* ... tu código igual ... */ }
async function adminCreateSession(){ /* ... tu código igual ... */ }
async function adminPrepareSessionDatesUI(){ /* ... tu código igual ... */ }
async function adminSaveSessionDates(){ /* ... tu código igual ... */ }
window.adminDeleteSession = async () => { /* ... tu código igual ... */ }
async function adminUploadEmployees(){ /* ... tu código igual ... */ }
async function adminSearchEmployees(){ /* ... tu código igual ... */ }
window.adminAddCitation = async () => { /* ... tu código igual ... */ }
async function adminUploadCitations(){ /* ... tu código igual ... */ }

/* =========================================================
   FORMADOR
========================================================= */
function wireTrainerHandlers(){
  $("btnRefreshTrainer").onclick = trainerInit;
}

async function trainerInit(){
  await trainerLoadSessions();
}

async function trainerLoadSessions(){
  const sb = getSB();
  const cont = $("trainerSessions");
  cont.innerHTML = `<div class="small">Cargando...</div>`;

  try{
    const { data: { user } } = await sb.auth.getUser();
    if(!user) throw new Error("No hay usuario autenticado.");

    const { data: sessions, error } = await sb
      .from("sessions")
      .select(`id, fecha, ciudad, estado, training_id, trainings ( nombre )`)
      .eq("formador_user_id", user.id)
      .order("fecha", { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!sessions?.length){
      cont.innerHTML = `<div class="item"><div class="small">No hay sesiones asignadas.</div></div>`;
      setStatus(`<span class="warn">Sin sesiones.</span>`);
      return;
    }

    cont.innerHTML = sessions.map(s => {
      const trName = s.trainings?.nombre || "Entrenamiento";
      return `
        <div class="item" id="sess_${s.id}">
          <div class="row" style="justify-content:space-between;">
            <div><b>${esc(trName)}</b></div>
            <span class="chip">${esc(s.estado || "—")}</span>
          </div>
          <div class="small" style="margin-top:6px;">Sesión · ${esc(s.fecha)} · ${esc(s.ciudad || "")}</div>

          <div class="row" style="margin-top:10px;">
            <div class="col">
              <label>Fecha a marcar</label>
              <select class="dateSelect" data-session="${esc(s.id)}">
                <option value="">Cargando fechas...</option>
              </select>
            </div>
            <div class="col" style="min-width:170px;">
              <label>&nbsp;</label>
              <button class="btnMini btnGhost" type="button" onclick="trainerRefreshSession('${s.id}')">Recargar</button>
            </div>
          </div>

          <!-- ===== NUEVO: Tema visto (obligatorio) ===== -->
          <div class="item" style="margin-top:10px;">
            <b>Tema visto (obligatorio)</b>
            <div class="small">Debes registrar el tema visto para esta fecha antes de marcar asistencia.</div>

            <label>Tema visto</label>
            <textarea class="temaInput" rows="2" placeholder="Ej: Normas de seguridad, práctica en campo, etc."></textarea>

            <div class="actions" style="margin-top:10px;">
              <button class="btnMini btnOk" type="button" onclick="trainerSaveTemaVisto('${s.id}')">Guardar tema visto</button>
              <button class="btnMini btnGhost" type="button" onclick="trainerLoadTemaVisto('${s.id}')">Cargar tema visto</button>
            </div>

            <div class="small temaMsg" style="margin-top:8px;"></div>
          </div>
          <!-- ========================================== -->

          <hr/>
          <b>Citados</b>
          <div class="small">Marca asistencia para la fecha seleccionada. “Tarde” cuenta como asistencia.</div>

          <div class="tablelike" style="margin-top:10px;">
            <div class="tr th">
              <div>Empleado</div><div>Asistió</div><div>No asistió</div><div>Llegó tarde</div>
            </div>
            <div class="tr"><div class="small">Cargando...</div><div></div><div></div><div></div></div>
          </div>
        </div>
      `;
    }).join("");

    for(const s of sessions){
      await trainerLoadDatesInto(s.id);
      // intenta cargar tema automáticamente cuando ya haya fecha seleccionada (si el select toma la 1ra)
      try{ await trainerLoadTemaVisto(s.id); }catch(_){}
      await trainerLoadCitadosInto(s.id);
    }

    setStatus(`<span class="ok">Sesiones cargadas.</span>`);
    setLog({ trainer_sessions: sessions });

  }catch(err){
    cont.innerHTML = `<div class="item"><div class="small"><span class="err">Error:</span> ${esc(err.message || err)}</div></div>`;
    setStatus(`<span class="err">Error cargando sesiones.</span>`);
    setLog(err);
  }
}

window.trainerRefreshSession = async (session_id) => {
  await trainerLoadDatesInto(session_id);
  await trainerLoadTemaVisto(session_id);
  await trainerLoadCitadosInto(session_id);
};

async function trainerLoadDatesInto(session_id){
  const sb = getSB();
  const sel = document.querySelector(`#sess_${CSS.escape(session_id)} .dateSelect`);
  if(!sel) return;

  try{
    const { data: dates, error } = await sb
      .from("session_dates")
      .select("id,fecha")
      .eq("session_id", session_id)
      .order("fecha", { ascending:true });

    if(error) throw error;

    if(!dates?.length){
      sel.innerHTML = `<option value="">(No hay fechas configuradas)</option>`;
      sel.onchange = null;
      return;
    }

    const prev = sel.value;
    sel.innerHTML = dates.map(d => `<option value="${esc(d.id)}">${esc(d.fecha)}</option>`).join("");
    if(prev && dates.some(d => d.id === prev)) sel.value = prev;

    sel.onchange = async () => {
      await trainerLoadTemaVisto(session_id);
      await trainerLoadCitadosInto(session_id);
    };

  }catch(e){
    sel.innerHTML = `<option value="">(Error cargando fechas)</option>`;
    setLog({ trainer_dates_error: e, session_id });
  }
}

/* ===== NUEVO: cargar/guardar Tema visto ===== */
window.trainerLoadTemaVisto = async (session_id) => {
  const sb = getSB();
  const sessBox = document.querySelector(`#sess_${CSS.escape(session_id)}`);
  if(!sessBox) return;

  const sel = sessBox.querySelector(".dateSelect");
  const fechaSeleccionada = sel?.options?.[sel.selectedIndex]?.textContent?.trim() || "";
  const fechaISO = normDateISO(fechaSeleccionada);

  const input = sessBox.querySelector(".temaInput");
  const msg = sessBox.querySelector(".temaMsg");

  if(msg) msg.innerHTML = "";

  if(!fechaISO){
    if(msg) msg.innerHTML = `<span class="warn">Selecciona una fecha para cargar el tema.</span>`;
    return;
  }

  try{
    const tema = await getTemaVisto(sb, session_id, fechaISO);
    if(input) input.value = tema || "";
    if(msg){
      msg.innerHTML = tema
        ? `<span class="ok">Tema cargado.</span>`
        : `<span class="warn">Aún no hay tema visto registrado para esta fecha.</span>`;
    }
  }catch(e){
    if(msg) msg.innerHTML = `<span class="err">Error cargando tema:</span> ${esc(e.message || e)}`;
    setLog({ trainer_load_tema_error: e, session_id, fechaISO });
  }
};

window.trainerSaveTemaVisto = async (session_id) => {
  const sb = getSB();
  const sessBox = document.querySelector(`#sess_${CSS.escape(session_id)}`);
  if(!sessBox) return;

  const sel = sessBox.querySelector(".dateSelect");
  const fechaSeleccionada = sel?.options?.[sel.selectedIndex]?.textContent?.trim() || "";
  const fechaISO = normDateISO(fechaSeleccionada);

  const input = sessBox.querySelector(".temaInput");
  const msg = sessBox.querySelector(".temaMsg");

  if(msg) msg.innerHTML = "";

  const tema = (input?.value ?? "").toString().trim();

  if(!fechaISO){
    if(msg) msg.innerHTML = `<span class="warn">Selecciona una fecha para guardar el tema.</span>`;
    return;
  }
  if(!tema){
    if(msg) msg.innerHTML = `<span class="warn">Escribe el tema visto (obligatorio).</span>`;
    return;
  }

  try{
    const { data: { user } } = await sb.auth.getUser();
    const payload = {
      session_id,
      fecha: fechaISO,
      tema_visto: tema,
      tema_visto_at: new Date().toISOString(),
      tema_visto_by: user?.id || null
    };

    // Requiere UNIQUE(session_id, fecha) en session_dates
    const { error } = await sb
      .from("session_dates")
      .upsert(payload, { onConflict: "session_id,fecha" });

    if(error) throw error;

    if(msg) msg.innerHTML = `<span class="ok">Tema visto guardado.</span>`;
    setStatus(`<span class="ok">Tema visto guardado.</span>`);
  }catch(e){
    if(msg) msg.innerHTML = `<span class="err">Error guardando tema:</span> ${esc(e.message || e)}`;
    setStatus(`<span class="err">Error guardando tema visto:</span> ${esc(e.message || e)}`);
    setLog({ trainer_save_tema_error: e, session_id, fechaISO });
  }
};
/* =========================================== */

async function trainerLoadCitadosInto(session_id){
  const sb = getSB();
  const sessBox = document.querySelector(`#sess_${CSS.escape(session_id)}`);
  if(!sessBox) return;

  const table = sessBox.querySelector(".tablelike");
  const sel = sessBox.querySelector(".dateSelect");
  const session_date_id = sel?.value || null;
  const fechaSeleccionada = sel?.options?.[sel.selectedIndex]?.textContent?.trim() || "";

  const header = table.querySelector(".tr.th");
  table.innerHTML = "";
  table.appendChild(header);

  if(!session_date_id || !fechaSeleccionada){
    table.insertAdjacentHTML("beforeend", `<div class="tr"><div class="small"><span class="warn">Selecciona una fecha.</span></div><div></div><div></div><div></div></div>`);
    return;
  }

  try{
    const { data: cit, error } = await sb
      .from("citations")
      .select(`employee_id, employees ( id, documento, nombre )`)
      .eq("session_id", session_id)
      .order("created_at", { ascending:true });

    if(error) throw error;

    if(!cit?.length){
      table.insertAdjacentHTML("beforeend", `<div class="tr"><div class="small">No hay citados.</div><div></div><div></div><div></div></div>`);
      return;
    }

    const empIds = cit.map(c => c.employee_id);

    // ✅ asistencia SOLO para la fecha seleccionada (incluye estado)
    const { data: at, error: e2 } = await sb
      .from("attendance_dates")
      .select("employee_id, asistio, estado")
      .eq("session_id", session_id)
      .eq("session_date", fechaSeleccionada)
      .in("employee_id", empIds);

    if(e2) throw e2;

    const attMap = new Map((at || []).map(a => [a.employee_id, { asistio: a.asistio, estado: a.estado }]));

    // total fechas de la sesión
    const { data: datesAll, error: e3 } = await sb
      .from("session_dates")
      .select("fecha")
      .eq("session_id", session_id);

    if(e3) throw e3;

    const allFechas = (datesAll || []).map(d => d.fecha).filter(Boolean);
    const totalDays = allFechas.length || 0;

    // asistencias true para todas las fechas (TARDE también cuenta porque asistio=true)
    let trueMap = new Map(); // employee_id -> count true
    if(allFechas.length){
      const { data: atAll, error: e4 } = await sb
        .from("attendance_dates")
        .select("employee_id, asistio, session_date")
        .eq("session_id", session_id)
        .in("session_date", allFechas)
        .in("employee_id", empIds);

      if(e4) throw e4;

      for(const row of (atAll || [])){
        if(row.asistio === true){
          trueMap.set(row.employee_id, (trueMap.get(row.employee_id)||0) + 1);
        }
      }
    }

    for(const c of cit){
      const emp = c.employees;
      const name = emp?.nombre ? `${emp.nombre} (${emp.documento || ""})` : (c.employee_id || "");

      const cur = attMap.get(c.employee_id) || null;
      const asistio = cur ? cur.asistio : null;
      const estadoActual = cur ? (cur.estado || null) : null; // "tarde" o null

      const attended = trueMap.get(c.employee_id) || 0;
      const apto = (totalDays > 0 && attended >= totalDays);
      const prog = (totalDays > 0) ? `${attended}/${totalDays} ${apto ? "· APTO" : "· NO APTO"}` : `0/0`;

      table.insertAdjacentHTML("beforeend", `
        <div class="tr">
          <div class="small">
            ${esc(name)}
            <div class="small" style="margin-top:4px;opacity:.9;">
              <span class="${apto ? "ok":"warn"}">${esc(prog)}</span>
              ${estadoActual === "tarde" ? `<span class="warn"> · TARDE</span>` : ``}
            </div>
          </div>
          <div>
            <button class="btnMini btnOk" type="button"
              onclick="trainerMark('${session_id}','${c.employee_id}','${esc(fechaSeleccionada)}',true,null)"
              ${asistio === true ? 'disabled' : ''}>Sí</button>
          </div>
          <div>
            <button class="btnMini btnBad" type="button"
              onclick="trainerMark('${session_id}','${c.employee_id}','${esc(fechaSeleccionada)}',false,null)"
              ${asistio === false ? 'disabled' : ''}>No</button>
          </div>
          <div>
            <button class="btnMini btnGhost" type="button"
              onclick="trainerMark('${session_id}','${c.employee_id}','${esc(fechaSeleccionada)}',true,'tarde')"
              ${estadoActual === 'tarde' ? 'disabled' : ''}>Tarde</button>
          </div>
        </div>
      `);
    }

  }catch(err){
    table.insertAdjacentHTML("beforeend", `
      <div class="tr">
        <div class="small"><span class="err">Error citados/asistencia:</span> ${esc(err.message || err)}</div><div></div><div></div><div></div>
      </div>
    `);
    setLog({ trainer_load_citados_error: err, session_id });
  }
}

window.trainerMark = async (session_id, employee_id, session_date, asistio, estado = null) => {
  const sb = getSB();
  setStatus("Guardando asistencia...");

  session_id = (session_id ?? "").toString().trim();
  employee_id = (employee_id ?? "").toString().trim();
  session_date = (session_date ?? "").toString().trim();

  if(!session_id){
    setStatus(`<span class="err">Error:</span> session_id vacío. Recarga la sesión y vuelve a intentar.`);
    setLog({ error: "session_id vacío", session_id, employee_id, session_date, asistio, estado });
    return;
  }
  if(!employee_id){
    setStatus(`<span class="err">Error:</span> employee_id vacío.`);
    setLog({ error: "employee_id vacío", session_id, employee_id, session_date, asistio, estado });
    return;
  }
  if(!session_date){
    setStatus(`<span class="err">Error:</span> Debes seleccionar una fecha.`);
    setLog({ error: "session_date vacío", session_id, employee_id, session_date, asistio, estado });
    return;
  }

  try{
    /* ===== NUEVO: BLOQUEO por Tema visto ===== */
    const fechaISO = normDateISO(session_date);
    const tema = await getTemaVisto(sb, session_id, fechaISO);

    if(!tema){
      setStatus(`<span class="warn">Debes registrar el “tema visto” para la fecha ${esc(fechaISO)} antes de guardar asistencia.</span>`);
      try{ await trainerLoadTemaVisto(session_id); }catch(_){}
      return;
    }
    /* ======================================== */

    // ✅ TARDE = asistio true + estado="tarde"
    const payload = { session_id, employee_id, session_date, asistio: !!asistio, estado: estado || null };
    setLog({ attendance_dates_upsert_payload: payload });

    const { error } = await sb
      .from("attendance_dates")
      .upsert(payload, { onConflict: "session_id,employee_id,session_date" });

    if(error) throw error;

    setStatus(`<span class="ok">Asistencia guardada.</span>`);
    await trainerLoadCitadosInto(session_id);

  }catch(err){
    setStatus(`<span class="err">Error guardando asistencia:</span> ${esc(err.message || err)}`);
    setLog(err);
  }
};

/* =========================================================
   INIT
========================================================= */
document.addEventListener("DOMContentLoaded", async () => {
  try{
    $("btnLogin").addEventListener("click", doLogin);
    $("btnForgot").addEventListener("click", doForgot);
    $("btnReset").addEventListener("click", doResetPassword);
    $("btnResetBack").addEventListener("click", goToLogin);

    $("email").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
    $("password").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

    if(!window.supabase){
      $("loginMsg").innerHTML = `<span class="err">No cargó Supabase JS (posible bloqueo del navegador).</span>`;
      return;
    }

    if(isRecoveryFlow()){
      showOnly("reset");
      $("resetMsg").innerHTML = `<span class="small">Cargando recuperación...</span>`;
      const sb = getSB();
      await sb.auth.getSession();
      $("resetMsg").innerHTML = `<span class="small">Ingresa tu nueva contraseña.</span>`;
      return;
    }

    await bootApp();
  }catch(e){
    $("loginMsg").innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
    setLog(e);
  }
});
</script>

</body>
</html>
