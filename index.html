<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Formación DICO – Asistencia (Admin + Formador)</title>

<!-- Supabase JS v2 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<!-- XLSX -->
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --violeta:#a78bfa; --violeta-osc:#7c3aed;
  --bg:#050617; --bg2:#111827; --card:#17182b;
  --text:#e8e6ff; --muted:#bfbde6; --border-soft:rgba(167,139,250,.25);
  --danger:#f97373; --success:#34d399; --warn:#facc15;
}
*{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,sans-serif;}
body{
  margin:0;min-height:100vh;
  background:radial-gradient(circle at top,var(--bg2),var(--bg));
  color:var(--text);
  display:flex;align-items:center;justify-content:center;
  padding:16px;
}
.hidden{display:none!important;}
.card{
  width:100%;max-width:480px;
  background:rgba(23,24,43,.85);
  border:1px solid var(--border-soft);
  border-radius:16px;
  padding:22px;
  box-shadow:0 20px 45px rgba(0,0,0,.55);
}
h1{margin:0 0 6px 0;color:var(--violeta);text-align:center;}
p{margin:0 0 14px 0;color:var(--muted);text-align:center;font-size:14px;}
label{display:block;margin-top:10px;color:var(--muted);font-size:12px;}
input, select, textarea{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  border:1px solid var(--border-soft);
  background:#0b0c1a;
  color:var(--text);
  font-size:14px;
}
input:focus, select:focus, textarea:focus{outline:none;border-color:var(--violeta);}
button{
  border:0;border-radius:10px;
  padding:12px 14px;
  background:var(--violeta);
  color:#050617;font-weight:900;
  cursor:pointer;
}
button:hover{background:var(--violeta-osc);}
button:disabled{opacity:.55;cursor:not-allowed;}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--border-soft);
  color:var(--muted);
  font-size:12px;
}
.small{font-size:12px;color:var(--muted);}
.ok{color:var(--success);font-weight:800;}
.err{color:var(--danger);font-weight:800;}
.warn{color:var(--warn);font-weight:800;}

.app{width:100%;max-width:1200px;}
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;margin-bottom:14px;flex-wrap:wrap;
}
.titleblock h2{margin:0;font-size:20px;}
.titleblock .small{margin-top:2px;}
.pillrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.grid{
  display:grid;
  grid-template-columns: 430px 1fr;
  gap:14px;
}
.grid.onecol{ grid-template-columns: 1fr; }
@media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

.panel{
  background:rgba(23,24,43,.75);
  border:1px solid var(--border-soft);
  border-radius:16px;
  padding:14px;
  box-shadow:0 18px 40px rgba(0,0,0,.4);
}
.panel h3{margin:0 0 10px 0;color:var(--violeta);}
hr{border:0;border-top:1px solid var(--border-soft);margin:12px 0;}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.col{flex:1;min-width:160px;}
.list{display:flex;flex-direction:column;gap:10px;}
.item{
  background:rgba(5,6,23,.35);
  border:1px solid var(--border-soft);
  border-radius:14px;
  padding:12px;
}
.item b{color:var(--text);}
.kv{display:grid;grid-template-columns: 140px 1fr;gap:6px;margin-top:6px;}
.kv div{font-size:12px;color:var(--muted);}
.kv div:nth-child(odd){color:rgba(191,189,230,.9);}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
pre{
  white-space:pre-wrap;
  background:#0b0c1a;
  border:1px solid var(--border-soft);
  border-radius:12px;
  padding:12px;
  margin:10px 0 0 0;
  color:var(--text);
  font-size:12px;
  overflow:auto;
  max-height:260px;
}
.chip{
  border:1px solid var(--border-soft);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  color:var(--muted);
  background:rgba(5,6,23,.25);
}
.tablelike{
  width:100%;
  border:1px solid var(--border-soft);
  border-radius:14px;
  overflow:hidden;
}
.tablelike .tr{
  display:grid;
  grid-template-columns: 1fr 120px 120px 120px; /* 4 cols */
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid rgba(167,139,250,.18);
}
.tablelike .tr:last-child{border-bottom:0;}
.tablelike .th{
  background:rgba(5,6,23,.45);
  color:var(--muted);
  font-size:12px;
  font-weight:800;
}
.btnMini{padding:10px 12px;border-radius:10px;font-weight:900;}
.btnGhost{background:transparent;border:1px solid var(--border-soft);color:var(--text);}
.btnGhost:hover{background:rgba(167,139,250,.10);}
.btnDanger{background:transparent;border:1px solid rgba(248,113,113,.65);color:#ffd8d8;}
.btnDanger:hover{border-color:rgba(248,113,113,1);}
.btnOk{background:rgba(52,211,153,.95); color:#050617;}
.btnBad{background:rgba(248,113,113,.95); color:#050617;}
.btnOk:hover,.btnBad:hover{filter:brightness(1.05);}
code{color:#fff;}

/* ===== FORMADOR: ocultar panel izquierdo + 1 columna ===== */
body.formador .grid{ grid-template-columns: 1fr !important; }
body.formador #leftPanel{ display:none !important; }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="card">
  <h1>Formación DICO</h1>
  <p>Ingreso al sistema de asistencia</p>

  <label>Correo</label>
  <input id="email" type="email" placeholder="correo@dico.com.co" autocomplete="username" />

  <label>Contraseña</label>
  <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />

  <div class="row" style="margin-top:14px;">
    <button id="btnLogin" type="button" style="width:100%;">Ingresar</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="btnForgot" type="button" class="btnMini btnGhost" style="width:100%;">Recuperar contraseña (crear clave)</button>
  </div>

  <div id="loginMsg" class="small" style="margin-top:10px;text-align:center;"></div>
</div>

<!-- RESET PASSWORD -->
<div id="resetBox" class="card hidden">
  <h1>Restablecer contraseña</h1>
  <p>Ingresa tu nueva contraseña para finalizar la recuperación</p>

  <label>Nueva contraseña</label>
  <input id="newPassword" type="password" placeholder="Mínimo 6 caracteres" autocomplete="new-password" />

  <label>Confirmar contraseña</label>
  <input id="newPassword2" type="password" placeholder="Repite la contraseña" autocomplete="new-password" />

  <div class="row" style="margin-top:14px;">
    <button id="btnReset" type="button" style="width:100%;">Guardar contraseña</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="btnResetBack" type="button" class="btnMini btnGhost" style="width:100%;">Volver al login</button>
  </div>

  <div id="resetMsg" class="small" style="margin-top:10px;text-align:center;"></div>
</div>

<!-- APP -->
<div id="app" class="hidden app">
  <div class="topbar">
    <div class="titleblock">
      <h2 id="panelTitle">Panel</h2>
      <div class="small" id="whoami">—</div>
    </div>
    <div class="pillrow">
      <span class="badge" id="roleBadge">rol</span>

      <button id="btnRevokeOthers" class="btnMini btnDanger hidden" type="button" title="Cierra sesiones activas en otros dispositivos (no te saca a ti)">
        Cerrar otras sesiones
      </button>

      <button id="btnLogout" class="btnMini" type="button">Cerrar sesión</button>
    </div>
  </div>

  <div class="grid">
    <div class="panel" id="leftPanel"></div>
    <div class="panel" id="rightPanel"></div>
  </div>

  <div class="panel" style="margin-top:14px;">
    <h3>Estado</h3>
    <div id="status" class="small">Listo.</div>
    <pre id="log">(vacío)</pre>
  </div>
</div>

<script>
/* =========================================================
   CONFIGURA AQUÍ TUS DATOS DE SUPABASE
========================================================= */
const SUPABASE_URL = "https://bqlltjronzrlgbjjntes.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_j84bjNzsEw1O-zsvliQ4Wg_BhGkSqR_";

// ✅ TU URL REAL (GitHub Pages). Debe abrir el MISMO archivo donde está este código.
const RESET_REDIRECT_TO = "https://formaciondicosa-claro.github.io/formacion/#reset";

const EMP_HEADERS = ["documento","nombre","cargo","area","supervisor","email","estado"];
const CITE_HEADERS = ["session_id","documento"];

/* =========================================================
   HELPERS
========================================================= */
const $ = (id) => document.getElementById(id);
const $status = $("status");
const $log = $("log");

function setStatus(html){ $status.innerHTML = html; }
function setLog(obj){ $log.textContent = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2); }
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function val(x){ return String(x ?? "").trim(); }

/* ========= helpers Tema visto (si ya los usas en tu archivo real, déjalos) ========= */
function normDateISO(d){
  const s = String(d || "").trim();
  if(!s) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  return s.slice(0,10);
}
async function getTemaVisto(sb, session_id, fechaISO){
  const { data, error } = await sb
    .from("session_dates")
    .select("tema_visto")
    .eq("session_id", session_id)
    .eq("fecha", fechaISO)
    .maybeSingle();
  if(error) throw error;
  return (data?.tema_visto ?? "").toString().trim();
}
/* ================================================================================== */

function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function downloadTextFile(content, filename, mime){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 600);
}

/* =========================================================
   DETECCIÓN RESET (hash + query)
========================================================= */
function isRecoveryFlow(){
  const h = (window.location.hash || "").toLowerCase();
  const q = (window.location.search || "").toLowerCase();
  return (
    h.includes("type=recovery") || q.includes("type=recovery") ||
    h.includes("#reset") ||
    h.includes("access_token=") || q.includes("access_token=") ||
    h.includes("refresh_token=") || q.includes("refresh_token=")
  );
}
function showOnly(view){
  $("login").classList.toggle("hidden", view !== "login");
  $("resetBox").classList.toggle("hidden", view !== "reset");
  $("app").classList.toggle("hidden", view !== "app");
}
function goToLogin(){
  window.location.hash = "";
  showOnly("login");
  $("loginMsg").innerHTML = `<span class="small">Listo para iniciar sesión.</span>`;
}

/* =========================================================
   SUPABASE
========================================================= */
function getSB(){
  if(!window.supabase || !window.supabase.createClient){
    throw new Error("No se cargó Supabase JS. Abre desde GitHub Pages o revisa bloqueos.");
  }
  window.__sb = window.__sb || window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_PUBLISHABLE_KEY,
    {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    }
  );
  return window.__sb;
}

/* =========================================================
   AUTH
========================================================= */
async function doLogin(){
  const sb = getSB();
  const email = val($("email").value);
  const password = val($("password").value);
  const btn = $("btnLogin");
  const msg = $("loginMsg");

  msg.innerHTML = "";
  if(!email || !password){
    msg.innerHTML = `<span class="err">Debes ingresar correo y contraseña.</span>`;
    return;
  }

  btn.disabled = true;
  btn.textContent = "Ingresando...";
  msg.innerHTML = `<span class="small">Validando...</span>`;

  try{
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    setLog({ login_data: data, login_error: error });

    if(error){
      msg.innerHTML = `<span class="err">${esc(error.message)}</span>`;
      return;
    }
    if(!data?.session){
      msg.innerHTML = `<span class="err">No se obtuvo sesión. Revisa credenciales.</span>`;
      return;
    }

    await bootApp();
  }catch(e){
    msg.innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
  }finally{
    btn.disabled = false;
    btn.textContent = "Ingresar";
  }
}

async function doForgot(){
  const sb = getSB();
  const email = val($("email").value);
  const msg = $("loginMsg");
  msg.innerHTML = "";

  if(!email){
    msg.innerHTML = `<span class="err">Escribe el correo en el campo Correo.</span>`;
    return;
  }

  try{
    // ✅ IMPORTANTE: usar constante (NO “quemar” URL)
    const redirectTo = RESET_REDIRECT_TO;

    const { data, error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
    setLog({ reset_data: data, reset_error: error, redirectTo });

    if(error){
      msg.innerHTML = `<span class="err">${esc(error.message)}</span>`;
      return;
    }
    msg.innerHTML = `<span class="ok">Listo.</span> Revisa tu correo (usa el mensaje más reciente) y abre el enlace para crear la contraseña.`;
  }catch(e){
    msg.innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
  }
}

async function doLogout(){
  const sb = getSB();
  await sb.auth.signOut();
  location.reload();
}

async function doResetPassword(){
  const sb = getSB();
  const msg = $("resetMsg");
  const btn = $("btnReset");

  const p1 = val($("newPassword").value);
  const p2 = val($("newPassword2").value);

  msg.innerHTML = "";

  if(!p1 || p1.length < 6){
    msg.innerHTML = `<span class="err">Mínimo 6 caracteres.</span>`;
    return;
  }
  if(p1 !== p2){
    msg.innerHTML = `<span class="err">Las contraseñas no coinciden.</span>`;
    return;
  }

  btn.disabled = true;
  btn.textContent = "Guardando...";

  try{
    // ✅ en recovery debe existir session; si no, link inválido/expirado
    const { data: sessData, error: sessErr } = await sb.auth.getSession();
    setLog({ reset_getSession_data: sessData, reset_getSession_error: sessErr });

    if(sessErr || !sessData?.session){
      msg.innerHTML = `<span class="err">El enlace expiró o es inválido.</span><br/><span class="small">Vuelve a pulsar "Recuperar contraseña" y usa el correo más reciente.</span>`;
      return;
    }

    const { data, error } = await sb.auth.updateUser({ password: p1 });
    setLog({ updateUser_data: data, updateUser_error: error });

    if(error){
      msg.innerHTML = `<span class="err">${esc(error.message)}</span>`;
      return;
    }

    msg.innerHTML = `<span class="ok">Contraseña actualizada.</span> Ya puedes iniciar sesión.`;
    setTimeout(() => { goToLogin(); }, 1200);

  }catch(e){
    msg.innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
    setLog(e);
  }finally{
    btn.disabled = false;
    btn.textContent = "Guardar contraseña";
  }
}

/* =========================================================
   PROFILE / APP (tu app sigue igual; aquí lo dejo mínimo)
========================================================= */
async function getProfile(user){
  const sb = getSB();
  const { data, error } = await sb
    .from("profiles")
    .select("user_id,nombre,rol,activo")
    .eq("user_id", user.id)
    .maybeSingle();
  if(error) throw error;

  if(!data){
    return { user_id: user.id, nombre: (user.email||"usuario").split("@")[0], rol: "formador", activo: true, __missing:true };
  }
  return data;
}

function setPanels(role){
  // IMPORTANTE: aquí va tu render real (admin + trainer). No lo cambio.
  // Si tu archivo original tiene todo el módulo, deja tu código tal cual.
}

let STATE = { user:null, profile:null };

async function bootApp(){
  const sb = getSB();
  const { data: { session } } = await sb.auth.getSession();

  if(!session){
    showOnly("login");
    $("loginMsg").innerHTML = `<span class="small">Listo para iniciar sesión.</span>`;
    return;
  }

  const user = session.user;
  const profile = await getProfile(user);

  STATE.user = user;
  STATE.profile = profile;

  showOnly("app");

  $("whoami").textContent = `${user.email}  ·  ${profile.nombre || ""}  ·  uid: ${user.id}`;
  $("roleBadge").textContent = profile.rol || "formador";
  $("panelTitle").textContent = (profile.rol === "super_admin") ? "Módulo: Asignación de entrenamientos" : "Panel Formador";
  document.body.classList.toggle("formador", profile.rol !== "super_admin");
  $("btnLogout").onclick = doLogout;

  setPanels(profile.rol);

  setStatus(`<span class="ok">Sesión activa.</span>`);
  setLog({ session_user: user, profile });
}

/* =========================================================
   INIT
========================================================= */
document.addEventListener("DOMContentLoaded", async () => {
  try{
    $("btnLogin").addEventListener("click", doLogin);
    $("btnForgot").addEventListener("click", doForgot);
    $("btnReset").addEventListener("click", doResetPassword);
    $("btnResetBack").addEventListener("click", goToLogin);

    $("email").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });
    $("password").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

    if(!window.supabase){
      $("loginMsg").innerHTML = `<span class="err">No cargó Supabase JS (posible bloqueo del navegador).</span>`;
      return;
    }

    // ✅ RECOVERY: valida sesión del link ANTES de permitir guardar contraseña
    if(isRecoveryFlow()){
      showOnly("reset");
      $("resetMsg").innerHTML = `<span class="small">Validando enlace...</span>`;
      const sb = getSB();

      const { data, error } = await sb.auth.getSession();
      setLog({ recovery_getSession_data: data, recovery_getSession_error: error });

      if(error || !data?.session){
        $("resetMsg").innerHTML = `
          <span class="err">El enlace expiró o es inválido.</span><br/>
          <span class="small">Vuelve a pulsar "Recuperar contraseña" y usa el correo más reciente.</span>
        `;
        return;
      }

      $("resetMsg").innerHTML = `<span class="small">Ingresa tu nueva contraseña.</span>`;
      return;
    }

    await bootApp();
  }catch(e){
    $("loginMsg").innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
    setLog(e);
  }
});
</script>

</body>
</html>
