<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Formaci√≥n DICO ‚Äì Dashboard Super Admin</title>

<!-- Supabase JS v2 -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
:root{
  --violeta:#a78bfa; --violeta-osc:#7c3aed;
  --bg:#050617; --bg2:#111827; --card:#17182b;
  --text:#e8e6ff; --muted:#bfbde6; --border-soft:rgba(167,139,250,.25);
  --danger:#f97373; --success:#34d399; --warn:#facc15; --info:#38bdf8;
}
*{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,sans-serif;}
body{
  margin:0;min-height:100vh;
  background:radial-gradient(circle at top,var(--bg2),var(--bg));
  color:var(--text);
  padding:16px;
}
.hidden{display:none!important;}
.card{
  width:100%;
  background:rgba(23,24,43,.85);
  border:1px solid var(--border-soft);
  border-radius:16px;
  padding:18px;
  box-shadow:0 20px 45px rgba(0,0,0,.55);
}
h1{margin:0 0 6px 0;color:var(--violeta);}
p{margin:0 0 14px 0;color:var(--muted);font-size:14px;}
label{display:block;margin-top:10px;color:var(--muted);font-size:12px;}
input, select{
  width:100%; padding:12px; margin-top:8px;
  border-radius:10px; border:1px solid var(--border-soft);
  background:#0b0c1a; color:var(--text); font-size:14px;
}
input:focus, select:focus{outline:none;border-color:var(--violeta);}
button{
  border:0;border-radius:10px;
  padding:12px 14px;
  background:var(--violeta);
  color:#050617;font-weight:900;
  cursor:pointer;
}
button:hover{background:var(--violeta-osc);}
button:disabled{opacity:.55;cursor:not-allowed;}
.badge{
  display:inline-block; padding:4px 10px; border-radius:999px;
  border:1px solid var(--border-soft); color:var(--muted); font-size:12px;
}
.small{font-size:12px;color:var(--muted);}
.ok{color:var(--success);font-weight:800;}
.err{color:var(--danger);font-weight:800;}
.warn{color:var(--warn);font-weight:800;}
.info{color:var(--info);font-weight:800;}

.app{max-width:1250px;margin:0 auto;}
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;margin-bottom:14px;flex-wrap:wrap;
}
.pillrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.grid{
  display:grid;
  grid-template-columns: 420px 1fr;
  gap:14px;
}
@media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
.panel{
  background:rgba(23,24,43,.75);
  border:1px solid var(--border-soft);
  border-radius:16px;
  padding:14px;
  box-shadow:0 18px 40px rgba(0,0,0,.4);
}
.panel h3{margin:0 0 10px 0;color:var(--violeta);}
hr{border:0;border-top:1px solid var(--border-soft);margin:12px 0;}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.col{flex:1;min-width:160px;}

.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
@media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr);} }
.kpi{
  background:rgba(5,6,23,.35);
  border:1px solid var(--border-soft);
  border-radius:14px;
  padding:12px;
}
.kpi .lbl{font-size:12px;color:var(--muted);font-weight:800;}
.kpi .val{font-size:20px;font-weight:950;margin-top:6px;}
.kpi .hint{font-size:12px;color:var(--muted);margin-top:4px;}

.list{display:flex;flex-direction:column;gap:10px;}
.item{
  background:rgba(5,6,23,.35);
  border:1px solid var(--border-soft);
  border-radius:14px;
  padding:12px;
}
.item b{color:var(--text);}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.btnMini{padding:10px 12px;border-radius:10px;font-weight:900;}
.btnGhost{background:transparent;border:1px solid var(--border-soft);color:var(--text);}
.btnGhost:hover{background:rgba(167,139,250,.10);}
.btnDanger{background:transparent;border:1px solid rgba(248,113,113,.65);color:#ffd8d8;}
.btnDanger:hover{border-color:rgba(248,113,113,1);}
code{color:#fff;}

.tablelike{
  width:100%;
  border:1px solid var(--border-soft);
  border-radius:14px;
  overflow:hidden;
}
.tablelike .tr{
  display:grid;
  grid-template-columns: 1fr 120px 120px 120px 90px;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid rgba(167,139,250,.18);
}
.tablelike .tr:last-child{border-bottom:0;}
.tablelike .th{
  background:rgba(5,6,23,.45);
  color:var(--muted);
  font-size:12px;
  font-weight:800;
}
.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px; border-radius:999px;
  border:1px solid var(--border-soft);
  background:rgba(5,6,23,.25);
  color:var(--muted);
  font-size:12px;
}
  #absenceAlerts .tr{
  grid-template-columns: 1fr 120px 1fr 120px 120px 70px;
}

/* ‚úÖ RESUMEN POR FECHA: 6 columnas fijas */
#summaryByDate .tr{
  display:grid !important;
  grid-template-columns: 160px 120px 120px 140px 90px minmax(260px, 2fr) !important;
  gap:10px;
  align-items:start;
}
#summaryByDate .tr > div{ min-width:0; word-break:break-word; overflow-wrap:break-word; }

#detailTable .tr{
  display:grid !important;
  grid-template-columns: 1fr 160px 120px 1fr 110px 140px !important;
  gap:10px;
  align-items:center;
}

#detailTable .tr > div{ min-width:0; overflow-wrap:break-word; word-break:break-word; }

/* ‚úÖ HISTORIAL: columnas fijas y estables */
#histTable .tr{
  display: grid !important;
  grid-template-columns:
    minmax(320px, 2fr)   /* Sesi√≥n */
    110px               /* Fecha */
    90px                /* Asisti√≥ */
    150px               /* Ciudad */
    170px               /* Formador */
    minmax(300px, 2.2fr) /* Tema */
  !important;

  gap: 12px;
  align-items: start;
}

</style>
</head>

<body>
<div class="app">
  
  <!-- LOGIN -->
  <div id="login" class="card" style="max-width:480px;margin:40px auto;">
    <h1>Dashboard Super Admin</h1>
    <p>Ingreso (solo rol <b>super_admin</b>)</p>

    <label>Correo</label>
    <input id="email" type="email" placeholder="correo@dico.com.co" autocomplete="username" />

    <label>Contrase√±a</label>
    <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />

    <div class="row" style="margin-top:14px;">
      <button id="btnLogin" type="button" style="width:100%;">Ingresar</button>
    </div>

    <div id="loginMsg" class="small" style="margin-top:10px;text-align:center;"></div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <div class="topbar">
      <div>
        <h1 style="margin:0;">Dashboard ‚Äì Asistencia</h1>
        <div class="small" id="whoami">‚Äî</div>
      </div>
      <div class="pillrow">
        <span class="badge" id="roleBadge">rol</span>
        <span class="pill" id="pillStatus">Listo</span>

        <button id="btnBack" class="btnMini btnGhost" type="button">Volver a Asignaci√≥n</button>
        <button id="btnReload" class="btnMini btnGhost" type="button">Actualizar</button>
        <button id="btnLogout" class="btnMini btnDanger" type="button">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <h3>Sesiones</h3>
        <div class="small">Filtra y entra a una sesi√≥n.</div>
        <hr/>

        <label>Buscar (entrenamiento/ciudad/formador)</label>
        <input id="fSearch" placeholder="Ej: alturas, bogot√°, juan..." />

        <div class="row">
          <div class="col">
            <label>Entrenamiento</label>
            <select id="fTraining"><option value="">Todos</option></select>
          </div>
          <div class="col">
            <label>Estado</label>
            <select id="fState">
  <option value="">Todos</option>
  <option value="programada">programada</option>
  <option value="en_curso">en_curso</option>
  <option value="cancelada">cancelada</option>
</select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Ciudad</label>
            <input id="fCity" placeholder="Bogot√°" />
          </div>
          <div class="col">
            <label>Formador</label>
            <select id="fTrainer"><option value="">Todos</option></select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Fecha desde</label>
            <input id="fFrom" type="date" />
          </div>
          <div class="col">
            <label>Fecha hasta</label>
            <input id="fTo" type="date" />
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnApply" class="btnMini" type="button" style="flex:1;">Aplicar</button>
          <button id="btnClear" class="btnMini btnGhost" type="button" style="flex:1;">Limpiar</button>
        </div>

        <hr/>
        <div id="sessionsList" class="list">
          <div class="small">Cargando...</div>
        </div>
      </div>

     <!-- RIGHT -->
<div class="panel">

  <h3>‚ö†Ô∏è Alertas de abandono</h3>
  <div class="small">
    Personas con <b>3 o m√°s d√≠as consecutivos</b> sin asistencia en sesiones multidiarias.
  </div>

  <div class="tablelike" style="margin-top:10px;" id="absenceAlerts">
    <div class="tr th">
      <div>Empleado</div>
      <div>Documento</div>
      <div>Sesi√≥n</div>
      <div>Desde</div>
      <div>Hasta</div>
      <div>D√≠as</div>
    </div>
  </div>
<hr/>

<h3>üì¶ Entregados a Operaci√≥n (por cargo)</h3>
<div class="small">Selecciona un rango de fechas y genera el reporte. (Tabla: <code>session_exits</code>)</div>

<div class="row" style="margin-top:10px;">
  <div class="col">
    <label>Desde</label>
    <input id="exFrom" type="date" />
  </div>
  <div class="col">
    <label>Hasta</label>
    <input id="exTo" type="date" />
  </div>
</div>

<div class="row" style="margin-top:10px;">
  <button id="btnExRun" class="btnMini btnGhost" type="button">Consultar</button>
  <button id="btnExCsv" class="btnMini btnGhost" type="button" disabled>Exportar CSV</button>
  <div class="small" id="exMsg" style="margin-left:auto;"></div>
</div>

<div class="tablelike" style="margin-top:10px;" id="exTable">
  <div class="tr th" style="grid-template-columns: 1fr 160px;">
    <div>Cargo</div>
    <div>Total entregados</div>
  </div>
</div>

  <hr/>

  <h3>Detalle de sesi√≥n</h3>
  <div class="small" id="sessionMeta">Selecciona una sesi√≥n a la izquierda.</div>
        <hr/>
        <div class="kpis">
          <div class="kpi"><div class="lbl">Citados (total)</div><div class="val" id="kCited">‚Äî</div><div class="hint" id="kCitedHint"></div></div>
          <div class="kpi"><div class="lbl">Fechas (session_dates)</div><div class="val" id="kDates">‚Äî</div><div class="hint"></div></div>
          <div class="kpi"><div class="lbl">Asistencias (sum)</div><div class="val" id="kYes">‚Äî</div><div class="hint">Tarde cuenta como asisti√≥</div></div>
          <div class="kpi"><div class="lbl">% asistencia (promedio)</div><div class="val" id="kPct">‚Äî</div><div class="hint">Promedio por fecha</div></div>
        </div>

        <hr/>
        <div class="row">
          <div class="col">
            <label>Fecha (para tabla detallada)</label>
            <select id="datePick"><option value="">‚Äî</option></select>
          </div>
          <div class="col" style="min-width:220px;">
            <label>&nbsp;</label>
            <div class="row">
              <button id="btnCsvDate" class="btnMini btnGhost" type="button" style="flex:1;">CSV (fecha)</button>
              <button id="btnCsvAll" class="btnMini btnGhost" type="button" style="flex:1;">CSV (todas)</button>
            </div>
          </div>
        </div>

        <!-- ‚úÖ Tema visto del d√≠a seleccionado -->
        <div class="small" style="margin-top:10px;" id="temaDiaBox"></div>

        <hr/>
        <b>Resumen por fecha</b>
        <div class="small">Basado en <code>session_date</code> y citaciones. Incluye ‚Äútema visto‚Äù.</div>

        <div class="tablelike" style="margin-top:10px;" id="summaryByDate">
          <div class="tr th">
            <div>Fecha</div><div>Citados</div><div>Asistieron</div><div>No asistieron</div><div>%</div><div>Tema visto</div>
          </div>
        </div>

        <hr/>
        <b>Detalle por empleado (fecha seleccionada)</b>
        <div class="small">Muestra empleados citados y su estado en esa fecha.</div>

        <div class="tablelike" style="margin-top:10px;" id="detailTable">
  <div class="tr th">
    <div>Empleado</div><div>Documento</div><div>Asisti√≥</div><div>Obs.</div><div>Incap.</div><div>Regresa</div>
  </div>
</div>


        <div class="small" style="margin-top:10px;" id="rightMsg"></div>

        <hr/>
        <b>Historial por colaborador</b>
        <div class="small">Consulta todas las asistencias registradas de un empleado (todas las sesiones y fechas), incluyendo <b>Formador</b> y <b>Tema visto</b>.</div>

        <div class="row" style="margin-top:10px;">
          <div class="col">
            <label>Buscar por documento (recomendado)</label>
            <input id="histDoc" placeholder="Ej: 1030123456" />
          </div>
          <div class="col">
            <label>o por employee_id (uuid)</label>
            <input id="histEmpId" placeholder="uuid del employee (si lo tienes)" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnHistBuscar" class="btnMini btnGhost" type="button">Buscar historial</button>
          <button id="btnHistLimpiar" class="btnMini btnGhost" type="button">Limpiar</button>
        </div>

        <div class="small" style="margin-top:10px;" id="histMsg"></div>

        <div class="tablelike" style="margin-top:10px;" id="histTable">
          <div class="tr th">
            <div>Sesi√≥n / Entrenamiento</div><div>Fecha</div><div>Asisti√≥</div><div>Ciudad</div><div>Formador</div><div>Tema visto</div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
/* =======================
   CONFIG SUPABASE
======================= */
const SUPABASE_URL = "https://bqlltjronzrlgbjjntes.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_j84bjNzsEw1O-zsvliQ4Wg_BhGkSqR_";

/* =======================
   HELPERS
======================= */
const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s ?? "")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

function setPill(txt, cls){
  const p = $("pillStatus");
  p.textContent = txt;
  p.style.borderColor = cls==="ok" ? "rgba(52,211,153,.55)" : cls==="err" ? "rgba(249,115,115,.6)" : "var(--border-soft)";
}

function downloadTextFile(content, filename, mime){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 600);
}
  function addDaysISO(isoDate, days){
  const d = new Date(isoDate + "T00:00:00");
  d.setDate(d.getDate() + days);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}


/* =======================
   SUPABASE CLIENT
======================= */
function getSB(){
  if(!window.supabase?.createClient) throw new Error("No se carg√≥ Supabase JS.");
  window.__sb = window.__sb || window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_PUBLISHABLE_KEY,
    { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
  );
  return window.__sb;
}

/* =======================
   STATE
======================= */
let STATE = {
  user:null,
  profile:null,
  sessions:[],
  trainings:[],
  trainers:[],
  selectedSessionId:null,
  selectedSession:null,
  sessionDates:[], // ahora: {fecha, tema_visto}
  citations:[],
  attendanceByDate: new Map(),
  temaByDate: new Map(),
};
let EXITS_REPORT_ROWS = []; // guarda filas del reporte para exportar

/* =======================
   AUTH / PROFILE
======================= */
async function getProfile(user){
  const sb = getSB();
  const { data, error } = await sb
    .from("profiles")
    .select("user_id,nombre,rol,activo")
    .eq("user_id", user.id)
    .maybeSingle();
  if(error) throw error;
  return data || null;
}

async function doLogin(){
  const sb = getSB();
  const email = ($("email").value || "").trim();
  const password = ($("password").value || "").trim();
  const msg = $("loginMsg");

  msg.innerHTML = "";
  if(!email || !password){
    msg.innerHTML = `<span class="err">Debes ingresar correo y contrase√±a.</span>`;
    return;
  }

  $("btnLogin").disabled = true;
  msg.innerHTML = `<span class="small">Ingresando...</span>`;

  try{
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error) throw error;
    if(!data?.session) throw new Error("No se obtuvo sesi√≥n.");
    await boot();
  }catch(e){
    msg.innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
  }finally{
    $("btnLogin").disabled = false;
  }
}

async function doLogout(){
  const sb = getSB();
  await sb.auth.signOut();
  location.reload();
}

async function boot(){
  const sb = getSB();
  const { data:{ session } } = await sb.auth.getSession();

  if(!session){
    $("login").classList.remove("hidden");
    $("app").classList.add("hidden");
    return;
  }

  STATE.user = session.user;
  STATE.profile = await getProfile(session.user);

  if(!STATE.profile){
    $("loginMsg").innerHTML = `<span class="err">No existe tu fila en profiles.</span>`;
    await doLogout();
    return;
  }
  if(STATE.profile.rol !== "super_admin"){
    $("loginMsg").innerHTML = `<span class="err">Acceso denegado. Tu rol es: ${esc(STATE.profile.rol)}</span>`;
    await doLogout();
    return;
  }

  $("login").classList.add("hidden");
  $("app").classList.remove("hidden");

  $("whoami").textContent = `${STATE.user.email} ¬∑ ${STATE.profile.nombre || ""} ¬∑ uid: ${STATE.user.id}`;
  $("roleBadge").textContent = STATE.profile.rol;

  $("btnLogout").onclick = doLogout;
  $("btnReload").onclick = initData;
  $("btnBack").onclick = () => { window.location.href = "index.html"; };

  $("btnApply").onclick = loadSessions;
  $("btnClear").onclick = clearFilters;

 $("datePick").onchange = () => renderDetailForSelectedDate();



  $("btnCsvDate").onclick = exportCsvSelectedDate;
  $("btnCsvAll").onclick = exportCsvAllDates;

  $("btnHistBuscar").onclick = buscarHistorialColaborador;
  // Reporte entregados a operaci√≥n
$("btnExRun").onclick = runExitsReport;
$("btnExCsv").onclick = exportExitsCsv;

  $("btnHistLimpiar").onclick = limpiarHistorialColaborador;

  await initData();
}

/* =======================
   DATA LOADERS
======================= */
async function initData(){
  setPill("Cargando‚Ä¶", "info");
  await Promise.all([ loadTrainings(), loadTrainers() ]);
  await Promise.all([ loadSessions(), loadAbsenceAlerts() ]); // ‚úÖ
  setPill("Listo", "ok");
}


async function loadTrainings(){
  const sb = getSB();
  const { data, error } = await sb
    .from("trainings")
    .select("id,nombre")
    .order("nombre", { ascending:true });
  if(error) throw error;
  STATE.trainings = data || [];

  $("fTraining").innerHTML =
    `<option value="">Todos</option>` +
    STATE.trainings.map(t => `<option value="${esc(t.id)}">${esc(t.nombre)}</option>`).join("");
}

async function loadTrainers(){
  const sb = getSB();
  const { data, error } = await sb
    .from("profiles")
    .select("user_id,nombre,rol,activo")
    .eq("activo", true)
    .order("nombre", { ascending:true });
  if(error) throw error;

  STATE.trainers = (data || []).filter(p => p.rol === "formador");

  $("fTrainer").innerHTML =
    `<option value="">Todos</option>` +
    STATE.trainers.map(p => `<option value="${esc(p.user_id)}">${esc(p.nombre)}</option>`).join("");
}

function clearFilters(){
  $("fSearch").value = "";
  $("fTraining").value = "";
  $("fCity").value = "";
  $("fTrainer").value = "";
  $("fState").value = "";
  $("fFrom").value = "";
  $("fTo").value = "";
  loadSessions();
}

async function loadSessions(){
  const sb = getSB();
  $("sessionsList").innerHTML = `<div class="small">Cargando sesiones...</div>`;
  setPill("Cargando sesiones‚Ä¶", "info");

  const search = ($("fSearch").value || "").trim().toLowerCase();
  const training_id = $("fTraining").value || "";
  const ciudad = ($("fCity").value || "").trim().toLowerCase();
  const formador = $("fTrainer").value || "";
  const estado = $("fState").value || "";
  const from = $("fFrom").value || "";
  const to = $("fTo").value || "";

  let q = sb.from("sessions")
    .select("id,training_id,fecha,ciudad,formador_user_id,estado, trainings(nombre)")
    .order("fecha", { ascending:false })
    .limit(300);
  q = q.neq("estado", "cerrada"); // ‚úÖ no mostrar cerradas
  if(training_id) q = q.eq("training_id", training_id);
  if(formador) q = q.eq("formador_user_id", formador);
  if(estado) q = q.eq("estado", estado);
  if(from) q = q.gte("fecha", from);
  if(to) q = q.lte("fecha", to);

  const { data, error } = await q;
  if(error){
    $("sessionsList").innerHTML = `<div class="small"><span class="err">Error:</span> ${esc(error.message)}</div>`;
    setPill("Error", "err");
    return;
  }

  let sessions = data || [];

  sessions = sessions.filter(s => {
    const trName = (s.trainings?.nombre || "").toLowerCase();
    const city = (s.ciudad || "").toLowerCase();
    const st = (s.estado || "").toLowerCase();
    const trainerName = (STATE.trainers.find(t => t.user_id === s.formador_user_id)?.nombre || "").toLowerCase();

    if(ciudad && !city.includes(ciudad)) return false;

    if(search){
      const hay = `${trName} ${city} ${trainerName} ${st} ${s.fecha || ""}`.toLowerCase();
      if(!hay.includes(search)) return false;
    }
    return true;
  });

  STATE.sessions = sessions;
  renderSessionsList();
  setPill("Listo", "ok");
}

function renderSessionsList(){
  const cont = $("sessionsList");
  const sessions = STATE.sessions;

  if(!sessions.length){
    cont.innerHTML = `<div class="item"><div class="small">No hay sesiones con esos filtros.</div></div>`;
    return;
  }

  cont.innerHTML = sessions.map(s => {
    const trName = s.trainings?.nombre || "(sin nombre)";
    const trainerName = STATE.trainers.find(t => t.user_id === s.formador_user_id)?.nombre || "(sin formador)";
    const isSel = (STATE.selectedSessionId === s.id);

    return `
      <div class="item" style="${isSel ? "border-color: rgba(52,211,153,.6)" : ""}">
        <div class="row" style="justify-content:space-between;">
          <b>${esc(trName)}</b>
          <span class="pill">${esc(s.estado || "‚Äî")}</span>
        </div>
        <div class="small" style="margin-top:6px;">
          ${esc(s.fecha)} ¬∑ ${esc(s.ciudad || "")}
        </div>
        <div class="small" style="margin-top:4px;">
          Formador: <span class="info">${esc(trainerName)}</span>
        </div>
        <div class="actions">
          <button class="btnMini btnGhost" type="button" onclick="selectSession('${esc(s.id)}')">Abrir</button>
        </div>
      </div>
    `;
  }).join("");
}
  async function loadAbsenceAlerts(){
  const sb = getSB();
  const cont = $("absenceAlerts");

  cont.innerHTML = `
    <div class="tr th">
      <div>Empleado</div>
      <div>Documento</div>
      <div>Sesi√≥n</div>
      <div>Desde</div>
      <div>Hasta</div>
      <div>D√≠as</div>
    </div>
  `;

  const { data, error } = await sb
    .from("v_absence_alerts_3days")
    .select("session_id,employee_id,documento,nombre,start_date,end_date,consecutive_absences,unmarked_days")
    .order("end_date", { ascending:false })
    .limit(100);

  if(error){
    cont.innerHTML += `
      <div class="tr">
        <div class="err">${esc(error.message)}</div>
        <div></div><div></div><div></div><div></div><div></div>
      </div>
    `;
    return;
  }

  if(!data || !data.length){
    cont.innerHTML += `
      <div class="tr">
        <div class="ok">Sin alertas activas</div>
        <div></div><div></div><div></div><div></div><div></div>
      </div>
    `;
    return;
  }

  for(const r of data){
    cont.innerHTML += `
      <div class="tr">
        <div>${esc(r.nombre || "")}</div>
        <div>${esc(r.documento || "")}</div>
        <div class="small"><code>${esc(r.session_id || "")}</code></div>
        <div>${esc(r.start_date || "")}</div>
        <div>${esc(r.end_date || "")}</div>
        <div class="warn"><b>${esc(r.consecutive_absences ?? "")}</b></div>
      </div>
    `;
  }
}


/* =======================
   SESSION DETAIL
======================= */
window.selectSession = async (session_id) => {
  STATE.selectedSessionId = session_id;
  STATE.selectedSession = STATE.sessions.find(s => s.id === session_id) || null;

  $("sessionMeta").innerHTML = `Cargando detalle...`;
  $("rightMsg").textContent = "";
  $("temaDiaBox").innerHTML = "";
  setPill("Cargando sesi√≥n‚Ä¶", "info");

  try{
    await Promise.all([
      loadSessionDates(session_id),
      loadCitations(session_id),
    ]);
   await loadAttendanceForAllDates(session_id);

renderSessionDetail();
setPill("Listo", "ok");
renderSessionsList();

  }catch(e){
    $("sessionMeta").innerHTML = `<span class="err">Error:</span> ${esc(e.message || e)}`;
    setPill("Error", "err");
  }
};

  function normDate(x){
  // deja solo YYYY-MM-DD por si viene con hora
  return (x ? String(x).slice(0,10) : "");
}

async function loadSessionDates(session_id){
  const sb = getSB();
  const { data, error } = await sb
    .from("session_dates")
    .select("fecha, tema_visto")
    .eq("session_id", session_id)
    .order("fecha", { ascending:true });

  if(error) throw error;

  // 1) cargar las fechas de session_dates
  let dates = (data || [])
    .filter(x => x?.fecha)
    .map(x => ({ fecha: normDate(x.fecha), tema_visto: x.tema_visto ?? null }));

  // 2) incluir la fecha principal de la sesi√≥n (sessions.fecha) si no est√° ya
  const mainFecha = normDate(STATE.selectedSession?.fecha);
  if(mainFecha && !dates.some(d => d.fecha === mainFecha)){
    dates.push({ fecha: mainFecha, tema_visto: null });
  }

  // 3) ordenar y quitar duplicados por seguridad
  dates.sort((a,b)=> String(a.fecha).localeCompare(String(b.fecha)));
  const seen = new Set();
  STATE.sessionDates = dates.filter(d => {
    if(seen.has(d.fecha)) return false;
    seen.add(d.fecha);
    return true;
  });
}


async function loadCitations(session_id){
  const sb = getSB();
  const { data, error } = await sb
    .from("citations")
    .select("employee_id, employees(documento,nombre,cargo,area,estado)")
    .eq("session_id", session_id);
  if(error) throw error;
  STATE.citations = data || [];
}

async function loadAttendanceForAllDates(session_id){
  const sb = getSB();
  STATE.attendanceByDate = new Map();
  STATE.temaByDate = new Map(); // ‚úÖ NUEVO

  const fechas = STATE.sessionDates.map(d => d.fecha);
  const empIds = STATE.citations.map(c => c.employee_id).filter(Boolean);

  if(!fechas.length) return;

  // 1) ASISTENCIA (solo citados)
  if(empIds.length){
    const { data: asisRows, error: e1 } = await sb
     .from("attendance_dates")
.select("session_date, employee_id, asistio, estado")
.eq("session_id", session_id)
.in("session_date", fechas)
      .in("employee_id", empIds);

    if(e1) throw e1;

    for(const row of (asisRows || [])){
      const f = row.session_date;
      if(!STATE.attendanceByDate.has(f)) STATE.attendanceByDate.set(f, new Map());
      STATE.attendanceByDate.get(f).set(row.employee_id, {
        asistio: row.asistio,
        estado: row.estado || null
      });
    }
  }

  // 2) TEMA (sin filtrar employee_id)
  const { data: temaRows, error: e2 } = await sb
    .from("attendance_dates")
    .select("session_date, tema")
    .eq("session_id", session_id)
    .in("session_date", fechas)
    .not("tema", "is", null);

  if(e2) throw e2;

  const counterByDate = new Map(); // fecha -> Map(tema->count)

  for(const r of (temaRows || [])){
    const f = r.session_date;
    const t = (r.tema ?? "").toString().trim();
    if(!t) continue;

    if(!counterByDate.has(f)) counterByDate.set(f, new Map());
    const m = counterByDate.get(f);
    m.set(t, (m.get(t) || 0) + 1);
  }

  for(const [f, m] of counterByDate.entries()){
    let bestTema = "";
    let bestCount = -1;
    for(const [t, c] of m.entries()){
      if(c > bestCount){
        bestCount = c;
        bestTema = t;
      }
    }
    if(bestTema) STATE.temaByDate.set(f, bestTema);
  }
}


function getTemaForFecha(fecha){
  return (STATE.temaByDate.get(fecha) || "").toString();
}
// ‚úÖ Trae mapas de ENTREGADO y RETIRADO para esta sesi√≥n
async function loadExitAndRetiroMaps(session_id){
  const sb = getSB();

  // --- ENTREGADOS ---
  const { data: exits, error: eEx } = await sb
    .from("session_exits")
    .select("employee_id, exit_date")
    .eq("session_id", session_id);

  if(eEx) throw eEx;

  // --- RETIRADOS ---
  const { data: rets, error: eRe } = await sb
    .from("session_withdrawals")
    .select("employee_id, retiro_date")
    .eq("session_id", session_id);

  if(eRe) throw eRe;

  // Mapas: employee_id -> fecha m√°s reciente
  const exitMap = new Map();
  for(const r of (exits || [])){
    const prev = exitMap.get(r.employee_id);
    if(!prev || String(r.exit_date) > String(prev)) exitMap.set(r.employee_id, r.exit_date);
  }

  const retiroMap = new Map();
  for(const r of (rets || [])){
    const prev = retiroMap.get(r.employee_id);
    if(!prev || String(r.retiro_date) > String(prev)) retiroMap.set(r.employee_id, r.retiro_date);
  }

  return { exitMap, retiroMap };
}


async function renderSessionDetail(){

  const s = STATE.selectedSession;
  if(!s){
    $("sessionMeta").textContent = "Selecciona una sesi√≥n.";
    return;
  }

  const trName = s.trainings?.nombre || "(sin nombre)";
  const trainerName = STATE.trainers.find(t => t.user_id === s.formador_user_id)?.nombre || "(sin formador)";

  $("sessionMeta").innerHTML = `
    <span class="badge">session_id: <code>${esc(s.id)}</code></span>
    <div class="small" style="margin-top:8px;">
      <b>${esc(trName)}</b> ¬∑ ${esc(s.fecha)} ¬∑ ${esc(s.ciudad || "")} ¬∑ Formador: <span class="info">${esc(trainerName)}</span>
    </div>
  `;

 const citedTotal = STATE.citations.length;
const datesTotal = STATE.sessionDates.length;

const rows = [];
let sumYes = 0;
let sumPct = 0;

const { exitMap, retiroMap } = await loadExitAndRetiroMaps(STATE.selectedSessionId);

for(const d of STATE.sessionDates){
  const fecha = d.fecha;

    const map = STATE.attendanceByDate.get(fecha) || new Map();

 
const activeCited = STATE.citations.filter(c => {
  const empId = c.employee_id;

  const retiro = retiroMap.get(empId) || null;
  const exit   = exitMap.get(empId) || null;

  // ‚úÖ desde el d√≠a siguiente: si fue ANTES de la fecha, ya no cuenta
  if(retiro && String(retiro) < String(fecha)) return false;
  if(exit && String(exit) < String(fecha)) return false;

  return true;
});

const citedEff = activeCited.length;

let yes = 0;
for(const c of activeCited){
  const rec = map.get(c.employee_id);
  if(rec && rec.asistio === true) yes++;
}

const no = citedEff - yes;
const pct = citedEff ? (yes / citedEff) * 100 : 0;


    sumYes += yes;
    sumPct += pct;

   rows.push({ fecha, cited: citedEff, yes, no, pct, tema: getTemaForFecha(fecha) || "" });

  }

  const avgPct = rows.length ? (sumPct / rows.length) : 0;


  $("kCited").textContent = String(citedTotal);
  $("kCitedHint").textContent = citedTotal ? "Basado en citations" : "";
  $("kDates").textContent = String(datesTotal);
  $("kYes").textContent = String(sumYes);
  $("kPct").textContent = `${avgPct.toFixed(1)}%`;

  const dp = $("datePick");
  dp.innerHTML = `<option value="">‚Äî</option>` + STATE.sessionDates
    .map(d => `<option value="${esc(d.fecha)}">${esc(d.fecha)}</option>`).join("");

  if (STATE.sessionDates.length) {
    dp.value = STATE.sessionDates[0].fecha;
    renderDetailForSelectedDate();
  } else {
    renderDetailEmpty();
  }

  const sum = $("summaryByDate");
  sum.innerHTML = `
    <div class="tr th">
      <div>Fecha</div><div>Citados</div><div>Asistieron</div><div>No asistieron</div><div>%</div><div>Tema visto</div>
    </div>
  ` + rows.map(r => `
    <div class="tr">
      <div><b>${esc(r.fecha)}</b></div>
      <div>${r.cited}</div>
      <div class="${r.yes ? "ok":""}">${r.yes}</div>
      <div class="${r.no ? "warn":""}">${r.no}</div>
      <div><b>${r.pct.toFixed(1)}%</b></div>
      <div class="small">${esc(r.tema || "‚Äî")}</div>
    </div>
  `).join("");
}

function renderDetailEmpty(){
  $("temaDiaBox").innerHTML = "";
  const dt = $("detailTable");
  dt.innerHTML = `
    <div class="tr th">
      <div>Empleado</div><div>Documento</div><div>Asisti√≥</div><div>Obs.</div>
    </div>
    <div class="tr">
      <div class="small"><span class="warn">Selecciona una fecha arriba para ver el detalle.</span></div>
      <div></div><div></div><div></div>
    </div>
  `;
}

async function renderDetailForSelectedDate(){
  const sb = getSB();

  const fecha = $("datePick").value || "";
  if(!fecha){
    renderDetailEmpty();
    return;
  }

  const tema = getTemaForFecha(fecha);
  $("temaDiaBox").innerHTML = tema
    ? `<span class="badge">Tema visto:</span> <span class="small">${esc(tema)}</span>`
    : `<span class="badge">Tema visto:</span> <span class="small">‚Äî</span>`;

  const cited = STATE.citations;
  const map = STATE.attendanceByDate.get(fecha) || new Map();

  const dt = $("detailTable");

  // ‚úÖ header 6 columnas
  dt.innerHTML = `
    <div class="tr th">
      <div>Empleado</div><div>Documento</div><div>Asisti√≥</div><div>Obs.</div><div>Incap.</div><div>Regresa</div>
    </div>
  `;

  if(!cited.length){
    dt.innerHTML += `
      <div class="tr">
        <div class="small">No hay citados.</div>
        <div></div><div></div><div></div><div></div><div></div>
      </div>
    `;
    return;
  }

  // ‚úÖ 1) sacar employee_ids citados
  const empIds = cited.map(c => c.employee_id).filter(Boolean);

  // ‚úÖ 2) consultar incapacidades activas EN ESA FECHA
  let incMap = new Map(); // employee_id -> hasta (m√°xima)
  if(empIds.length){
    const { data: incRows, error: eInc } = await sb
      .from("employee_incapacities")
      .select("employee_id, desde, hasta")
      .in("employee_id", empIds)
      .lte("desde", fecha)
      .gte("hasta", fecha);

    if(eInc){
      // si hay RLS o error, lo mostramos
      $("rightMsg").innerHTML = `<span class="err">Error leyendo incapacidades:</span> ${esc(eInc.message)}`;
    }else{
      for(const r of (incRows || [])){
        const prev = incMap.get(r.employee_id);
        if(!prev || String(r.hasta) > String(prev)) incMap.set(r.employee_id, r.hasta);
      }
    }
  }
    // ‚úÖ 3) ENTREGADO / RETIRADO (prioridad sobre asistencia)
  // Ajusta los nombres de tabla/columna si en tu BD se llaman distinto.
  let exitMap = new Map();      // employee_id -> exit_date (√∫ltima <= fecha)
  let retiroMap = new Map();    // employee_id -> retiro_date (√∫ltima <= fecha)

  if(empIds.length){
    // --- ENTREGADO a operaci√≥n ---
    {
      const { data: exits, error: eEx } = await sb
        .from("session_exits")
        .select("employee_id, exit_date")
        .in("employee_id", empIds)
        .eq("session_id", STATE.selectedSessionId)
        .lte("exit_date", fecha);

      if(eEx){
        $("rightMsg").innerHTML = `<span class="err">Error leyendo entregas:</span> ${esc(eEx.message)}`;
      } else {
        for(const r of (exits || [])){
          const prev = exitMap.get(r.employee_id);
          // nos quedamos con la fecha m√°s grande (m√°s reciente)
          if(!prev || String(r.exit_date) > String(prev)) exitMap.set(r.employee_id, r.exit_date);
        }
      }
    }

    // --- RETIRADO ---
    {
      const { data: rets, error: eRe } = await sb
        .from("session_withdrawals")
        .select("employee_id, retiro_date")
        .in("employee_id", empIds)
        .eq("session_id", STATE.selectedSessionId)
        .lte("retiro_date", fecha);

      if(eRe){
        $("rightMsg").innerHTML = `<span class="err">Error leyendo retiros:</span> ${esc(eRe.message)}`;
      } else {
        for(const r of (rets || [])){
          const prev = retiroMap.get(r.employee_id);
          if(!prev || String(r.retiro_date) > String(prev)) retiroMap.set(r.employee_id, r.retiro_date);
        }
      }
    }
  }


  // ‚úÖ ordenar por nombre
  const sorted = [...cited].sort((a,b)=>{
    const na = (a.employees?.nombre || "").toLowerCase();
    const nb = (b.employees?.nombre || "").toLowerCase();
    return na.localeCompare(nb);
  });

  for(const c of sorted){
    const emp = c.employees || {};
    const rec = map.get(c.employee_id) || null;

    const asistio = rec ? rec.asistio : null;
    const estado  = rec ? (rec.estado || "") : ""; // "tarde" si aplica

      // ‚úÖ prioridad: RETIRADO > ENTREGADO > INCAP > asistencia normal
    const retiroFecha = retiroMap.get(c.employee_id) || null;
    const exitFecha = exitMap.get(c.employee_id) || null;

    let asistioTxt = (asistio === true) ? "S√≠" : (asistio === false) ? "No" : "‚Äî";
    let obsTxt = (estado === "tarde") ? "Tarde" : "";

    if(retiroFecha){
      asistioTxt = `RETIRADO (${retiroFecha})`;
      obsTxt = "Retiro (abandono)";
    } else if(exitFecha){
      asistioTxt = `ENTREGADO (${exitFecha})`;
      obsTxt = "Entregado a operaci√≥n";
    }


// ‚úÖ incapacidad (primero definimos)
const incHasta = incMap.get(c.employee_id) || null;
const tieneIncap = !!incHasta;
const regresa = incHasta ? addDaysISO(incHasta, 1) : "";



let asistioTxtFinal = asistioTxt;
let asistClass = (asistio === true ? "ok" : asistio === false ? "warn" : "");

// prioridad de estilos
if(retiroFecha){
  asistioTxtFinal = `RETIRADO (${retiroFecha})`;
  asistClass = "err";
} else if(exitFecha){
  asistioTxtFinal = `ENTREGADO (${exitFecha})`;
  asistClass = "info";
} else if(tieneIncap){
  asistioTxtFinal = "INCAP";
  asistClass = "warn";
}



    dt.innerHTML += `
      <div class="tr">
        <div>${esc(emp.nombre || "")}</div>
        <div>${esc(emp.documento || "")}</div>
       <div class="${asistClass}">${esc(asistioTxtFinal)}</div>
        <div class="small">${esc(obsTxt)}</div>
        <div class="${tieneIncap ? "warn" : "small"}">${tieneIncap ? `INCAP. ${esc(incHasta)}` : "‚Äî"}</div>
        <div class="${tieneIncap ? "ok" : "small"}">${tieneIncap ? esc(regresa) : "‚Äî"}</div>
      </div>
    `;
  }
}

/* =======================
   HISTORIAL COLABORADOR
======================= */
async function buscarHistorialColaborador(){
  const sb = getSB();
  const doc = ($("histDoc").value || "").trim();
  const empId = ($("histEmpId").value || "").trim();

  $("histMsg").innerHTML = "";
  $("histTable").innerHTML = `
    <div class="tr th">
      <div>Sesi√≥n / Entrenamiento</div><div>Fecha</div><div>Asisti√≥</div><div>Ciudad</div><div>Formador</div><div>Tema visto</div>
    </div>
  `;

  try{
    setPill("Buscando historial‚Ä¶", "info");

    let employee_id = empId || "";

    if(!employee_id){
      if(!doc){
        $("histMsg").innerHTML = `<span class="warn">Ingresa documento o employee_id.</span>`;
        setPill("Listo", "ok");
        return;
      }

      const { data: emp, error: e1 } = await sb
        .from("employees")
        .select("id,documento,nombre")
        .eq("documento", doc)
        .maybeSingle();

      if(e1) throw e1;
      if(!emp?.id){
        $("histMsg").innerHTML = `<span class="warn">No se encontr√≥ empleado con documento ${esc(doc)}.</span>`;
        setPill("Listo", "ok");
        return;
      }
      employee_id = emp.id;
      $("histEmpId").value = employee_id;
    }

    // ‚úÖ Traemos tambi√©n formador_user_id para poder mostrar nombre del formador
    const { data, error } = await sb
      .from("attendance_dates")
      .select(`
        session_id,
        session_date,
        asistio,
        estado,
        sessions(ciudad, formador_user_id, trainings(nombre))
      `)
      .eq("employee_id", employee_id)
      .order("session_date", { ascending:false })
      .limit(800);

    if(error) throw error;

    const rows = data || [];
    if(!rows.length){
      $("histMsg").innerHTML = `<span class="warn">Este colaborador no tiene asistencias registradas.</span>`;
      setPill("Listo", "ok");
      return;
    }

    // ‚úÖ Map formadores (profiles)
    const trainerIds = [...new Set(rows.map(r => r.sessions?.formador_user_id).filter(Boolean))];
    let trainerMap = new Map();
    if(trainerIds.length){
      const { data: trs, error: eT } = await sb
        .from("profiles")
        .select("user_id,nombre")
        .in("user_id", trainerIds);
      if(eT) throw eT;
      trainerMap = new Map((trs || []).map(t => [t.user_id, t.nombre || ""]));
    }

    // ‚úÖ Map temas desde attendance_dates.tema (modo por session_id + fecha)
const sessionIds = [...new Set(rows.map(r => r.session_id).filter(Boolean))];
const fechas = [...new Set(rows.map(r => r.session_date).filter(Boolean))];

let temaMap = new Map(); // key: `${session_id}|${fecha}` -> tema (m√°s repetido)

if(sessionIds.length && fechas.length){
  const { data: trows, error: eS } = await sb
    .from("attendance_dates")
    .select("session_id, session_date, tema")
    .in("session_id", sessionIds)
    .in("session_date", fechas)
    .not("tema", "is", null);

  if(eS) throw eS;

  // contador por (session_id|fecha) -> Map(tema -> count)
  const counter = new Map();

  for(const r of (trows || [])){
    const key = `${r.session_id}|${r.session_date}`;
    const tema = (r.tema ?? "").toString().trim();
    if(!tema) continue;

    if(!counter.has(key)) counter.set(key, new Map());
    const m = counter.get(key);
    m.set(tema, (m.get(tema) || 0) + 1);
  }

  for(const [key, m] of counter.entries()){
    let best = "";
    let bestC = -1;
    for(const [t, c] of m.entries()){
      if(c > bestC){ bestC = c; best = t; }
    }
    if(best) temaMap.set(key, best);
  }
}

    for(const r of rows){
      const trainingName = r.sessions?.trainings?.nombre || "(sin entrenamiento)";
      const city = r.sessions?.ciudad || "";
      const asistTxt = (r.asistio === true) ? "S√≠" : (r.asistio === false) ? "No" : "‚Äî";
      const estadoTxt = r.estado || "‚Äî";

      const formadorId = r.sessions?.formador_user_id || "";
      const formadorNombre = formadorId ? (trainerMap.get(formadorId) || "(sin formador)") : "(sin formador)";

      const keyTema = `${r.session_id}|${r.session_date}`;
      const tema = temaMap.get(keyTema) || "";

     $("histTable").innerHTML += `
  <div class="tr">
    <div><b>${esc(trainingName)}</b></div>
    <div>${esc(r.session_date || "")}</div>
    <div class="${r.asistio === true ? "ok" : r.asistio === false ? "warn" : ""}">${esc(asistTxt)}</div>
    <div>${esc(city || "")}</div>
    <div class="small">${esc(formadorNombre || "")}</div>
    <div class="small histTema" title="${esc(tema || "")}">${esc(tema || "")}</div>
  </div>
`;
    }

    $("histMsg").innerHTML = `<span class="ok">Historial cargado:</span> ${rows.length} registros.`;
    setPill("Listo", "ok");
  }catch(e){
    $("histMsg").innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
    setPill("Error", "err");
  }
}

function limpiarHistorialColaborador(){
  $("histDoc").value = "";
  $("histEmpId").value = "";
  $("histMsg").innerHTML = "";
  $("histTable").innerHTML = `
    <div class="tr th">
      <div>Sesi√≥n / Entrenamiento</div><div>Fecha</div><div>Asisti√≥</div><div>Ciudad</div><div>Formador</div><div>Tema visto</div>
    </div>
  `;
}
/* =======================
   REPORTE: ENTREGADOS A OPERACI√ìN (POR CARGO)
======================= */
function renderExitsTable(rows){
  const cont = $("exTable");
  cont.innerHTML = `
    <div class="tr th" style="grid-template-columns: 1fr 160px;">
      <div>Cargo</div>
      <div>Total entregados</div>
    </div>
  `;

  if(!rows || !rows.length){
    cont.innerHTML += `
      <div class="tr" style="grid-template-columns: 1fr 160px;">
        <div class="small">Sin registros en el rango.</div>
        <div>0</div>
      </div>
    `;
    return;
  }

  for(const r of rows){
    cont.innerHTML += `
      <div class="tr" style="grid-template-columns: 1fr 160px;">
        <div>${esc(r.cargo || "(sin cargo)")}</div>
        <div><b>${esc(r.total_entregados ?? 0)}</b></div>
      </div>
    `;
  }
}

async function runExitsReport(){
  const sb = getSB();
  const from = $("exFrom").value || "";
  const to = $("exTo").value || "";

  $("exMsg").innerHTML = "";
  $("btnExCsv").disabled = true;
  EXITS_REPORT_ROWS = [];

  if(!from || !to){
    $("exMsg").innerHTML = `<span class="warn">Debes seleccionar Desde y Hasta.</span>`;
    return;
  }

  setPill("Consultando entregados‚Ä¶", "info");
  $("exMsg").innerHTML = `<span class="small">Consultando...</span>`;

  try{
    // 1) Traer exits por rango
    const { data: exits, error: e1 } = await sb
      .from("session_exits")
      .select("employee_id, exit_date")
      .gte("exit_date", from)
      .lte("exit_date", to);

    if(e1) throw e1;

    if(!exits || !exits.length){
      renderExitsTable([]);
      $("exMsg").innerHTML = `<span class="ok">Listo:</span> 0 entregados en el rango.`;
      setPill("Listo", "ok");
      return;
    }

    // 2) Obtener cargos desde employees
    const empIds = [...new Set(exits.map(x => x.employee_id).filter(Boolean))];

    const { data: emps, error: e2 } = await sb
      .from("employees")
      .select("id,cargo")
      .in("id", empIds);

    if(e2) throw e2;

    const cargoByEmp = new Map((emps || []).map(e => [e.id, (e.cargo || "").toString().trim()]));

    // 3) Contar por cargo
    const counts = new Map(); // cargo -> count
    for(const x of exits){
      const cargo = cargoByEmp.get(x.employee_id) || "(sin cargo)";
      counts.set(cargo, (counts.get(cargo) || 0) + 1);
    }

    // 4) Convertir a array ordenado
    const rows = [...counts.entries()]
      .map(([cargo, total]) => ({ cargo, total_entregados: total }))
      .sort((a,b)=> (b.total_entregados || 0) - (a.total_entregados || 0));

    EXITS_REPORT_ROWS = rows;

    renderExitsTable(rows);
    $("btnExCsv").disabled = rows.length === 0;

    $("exMsg").innerHTML = `<span class="ok">Listo:</span> ${exits.length} entregados (eventos) en el rango.`;
    setPill("Listo", "ok");
  }catch(e){
    $("exMsg").innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
    setPill("Error", "err");
  }
}

function exportExitsCsv(){
  const from = $("exFrom").value || "";
  const to = $("exTo").value || "";

  if(!EXITS_REPORT_ROWS.length){
    $("exMsg").innerHTML = `<span class="warn">Primero genera el reporte.</span>`;
    return;
  }

  const header = ["cargo","total_entregados"];
  const lines = [csvLine(header)];

  for(const r of EXITS_REPORT_ROWS){
    lines.push(csvLine([r.cargo || "", r.total_entregados ?? 0]));
  }

  const csv = lines.join("\n");
  const name = `entregados_operacion_por_cargo_${from}_a_${to}.csv`;
  downloadTextFile(csv, name, "text/csv;charset=utf-8");
  $("exMsg").innerHTML = `<span class="ok">CSV generado:</span> ${esc(name)}`;
}

/* =======================
   EXPORT CSV
======================= */
function csvLine(values){
  return values.map(v=>{
    const s = String(v ?? "");
    const needs = /[",\n;]/.test(s);
    const cleaned = s.replaceAll('"','""');
    return needs ? `"${cleaned}"` : cleaned;
  }).join(",");
}

function exportCsvSelectedDate(){
  const fecha = $("datePick").value || "";
  if(!STATE.selectedSessionId || !fecha){
    $("rightMsg").innerHTML = `<span class="warn">Selecciona sesi√≥n y fecha.</span>`;
    return;
  }
  const csv = buildCsvForDates([fecha]);
  const name = `asistencia_${STATE.selectedSessionId}_${fecha}.csv`;
  downloadTextFile(csv, name, "text/csv;charset=utf-8");
  $("rightMsg").innerHTML = `<span class="ok">CSV generado:</span> ${esc(name)}`;
}

function exportCsvAllDates(){
  if(!STATE.selectedSessionId){
    $("rightMsg").innerHTML = `<span class="warn">Selecciona una sesi√≥n.</span>`;
    return;
  }
  const fechas = STATE.sessionDates.map(d=>d.fecha);
  if(!fechas.length){
    $("rightMsg").innerHTML = `<span class="warn">La sesi√≥n no tiene fechas.</span>`;
    return;
  }
  const csv = buildCsvForDates(fechas);
  const name = `asistencia_${STATE.selectedSessionId}_todas_fechas.csv`;
  downloadTextFile(csv, name, "text/csv;charset=utf-8");
  $("rightMsg").innerHTML = `<span class="ok">CSV generado:</span> ${esc(name)}`;
}

function buildCsvForDates(fechas){
  const header = [
    "session_id","session_date",
    "employee_id","documento","nombre","cargo","area",
    "asistio","estado"
  ];

  const lines = [csvLine(header)];

  const cited = STATE.citations;
  for(const fecha of fechas){
    const map = STATE.attendanceByDate.get(fecha) || new Map();

    for(const c of cited){
      const emp = c.employees || {};
      const rec = map.get(c.employee_id) || null;

      const asistio = rec ? rec.asistio : "";
      const estado = rec ? (rec.estado || "") : "";

      lines.push(csvLine([
        STATE.selectedSessionId,
        fecha,
        c.employee_id,
        emp.documento || "",
        emp.nombre || "",
        emp.cargo || "",
        emp.area || "",
        asistio,
        estado
      ]));
    }
  }

  return lines.join("\n");
}

/* =======================
   INIT
======================= */
document.addEventListener("DOMContentLoaded", async ()=>{
  try{
    $("btnLogin").onclick = doLogin;
    $("password").addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });
    $("email").addEventListener("keydown",(e)=>{ if(e.key==="Enter") doLogin(); });
    await boot();
  }catch(e){
    $("loginMsg").innerHTML = `<span class="err">${esc(e.message || e)}</span>`;
  }
});
</script>
</body>
</html>

























